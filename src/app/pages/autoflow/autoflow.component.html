<div class="page-content">
  <div class="automation-container my-3">
    <form #automationForm="ngForm" (ngSubmit)="submitted=true; automationForm.form.valid ? storeData() : false;"
          [class.was-validated]="submitted">
      <div class="v-center my-2">
        <a [routerLink]="['/automations']" class="c-dark mr-2">
          <div class="f-8 ls-2 font-weight-bold text-uppercase">Automations</div>
        </a>
        <div class="f-8 font-weight-bold text-uppercase" *ngIf="editMode=='new'"> / Create Template</div>
      </div>
      <div class="align-items-top automation-name-wrapper mt-3">
        <div class="row">
          <div class="col-md-7 col-sm-12">
            <div class="form-group d-flex align-items-start">
              <div class="title w-100">
                <label for="automation-title">Title</label>
                <input class="form-control" id="automation-title" [(ngModel)]="automation_title" type="text"
                       name="automationTitle" #automationTitle="ngModel" placeholder="Type in new automation title" required>
                <span class="invalid-feedback"
                      *ngIf="automationTitle.errors&&(automationTitle.touched||automationTitle.dirty||submitted)&&submitted">Automation
                      name is required.</span>
              </div>
              <div class="btn-wrapper">
                <button class="btn btn-primary br-default" [class.loading]="isSaving" type="submit">
                  {{editMode == 'edit' ? 'Save' : 'Create'}}
                </button>
              </div>
            </div>
          </div>
          <div class="col-md-5 col-sm-12 mt-md-0 mt-sm-3">
            <div class="form-group v-center justify-content-end">
              <div class="auth">
                <label>Owner</label>
                <div class="h-40 v-center">
                  <ng-container *ngIf="automation; else newAutomation">
                    <div class="role" [class.admin]="automation.role == 'admin'" [class.team]="automation.role === 'team' && automation.user === user_id" [class.shared]="automation.role === 'team' && automation.user !== user_id"></div>
                  </ng-container>
                  <ng-template #newAutomation>
                    <div class="role own"></div>
                  </ng-template>
                </div>
              </div>
              <div class="created ml-4" align="end">
                <label>Created</label>
                <div class="h-40 v-center">
                  <div class="f-3 font-weight-bold">
                    {{created_at | date: 'dd/MM/yyyy'}}
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </form>
    <div class="card-body">
      <button class="d-none" (click)="clearAllNodes()">Clear</button>
      <!-- <div class="" draggable="true" (dragstart)="dragAction($event)">DRAG</div> -->
      <div class="flows-container" #wrapper>
        <div class="zoom-button-wrapper">
          <button class="v-center justify-content-center btn btn-white font-weight-bold mb-2" [class.disabled]="zoomLevel > 3" (click)="zoomIn()">
            <i class="bgc-blue i-icon i-plus"></i>
          </button>
          <button class="v-center justify-content-center btn btn-white font-weight-bold" [class.disabled]="zoomLevel === 0" (click)="zoomOut()">
            <i class="bgc-blue i-icon i-remove"></i>
          </button>
        </div>
        <div class="count-container">
          <div class="actions-count">
            <label class="f-1 text-uppercase">Actions</label>
            <div class="content actions">
              <p class="count font-weight-bold">{{automation && automation.automations.length ? automation.automations.length : 0}}</p>
            </div>
          </div>
          <div class="contacts-count mt-3" *ngIf="editMode == 'edit'">
            <label class="f-1 text-uppercase">Contacts</label>
            <div class="content contacts">
              <p class="count font-weight-bold">0</p>
            </div>
          </div>
        </div>
        <ng-container *ngIf="!nodes.length; else flowTemplate">
          <div class="init-graph-container">
            <ngx-graph class="chart-container init-container" [links]="initEdges" [nodes]="initNodes"
                       [layoutSettings]="layoutSettings" [layout]="layout" [curve]="curve" [draggingEnabled]="false"
                       [autoCenter]="false" [autoZoom]="autoZoom" [zoomLevel]="zoomLevel" [enableZoom]="true" [panOffsetY]="0"
                       [view]="[300, 200]">
              <ng-template #nodeTemplate let-node>
                <svg:g class="node">
                  <svg:rect [attr.width]="node.dimension.width" [attr.height]="node.dimension.height"
                            fill="transparent" />
                  <svg:foreignObject width="200" height="132">
                    <xhtml:div xmlns="http://www.w3.org/1999/xhtml" (click)="addAction()" (drop)="startDrop($event)"
                               (dragover)="allowStartDrop($event, node)" (dragleave)="disableStartArea($event, node)"
                               (dragenter)="enableStartArea($event, node)" [class.droppable]="node.droppable"
                               class="drop-target">
                      <xhtml:div class="cardContainer" style="margin-bottom: 5px; margin-top: 10px; text-align: center;"
                                 xmlns="http://www.w3.org/1999/xhtml">
                        <img [attr.src]="'./assets/img/automations/automation_start.svg'" x="75" y="0" height="50px"
                             width="50px" />
                      </xhtml:div>
                      <xhtml:div class="cardContainer"
                                 style="background-color: transparent; padding: 5px 8px; text-align: center; width: 150px; margin-left: 25px; margin-right: 25px;"
                                 xmlns="http://www.w3.org/1999/xhtml">
                        <label class="name" style="margin: 0; font-size: 13px;">Start</label>
                        <label class="name" style="margin: 0; font-size: 10px; color: #aaa;">
                          DRAG'N'DROP ACTION OR CLICK HERE
                        </label>
                      </xhtml:div>
                    </xhtml:div>
                  </svg:foreignObject>
                </svg:g>
              </ng-template>
            </ngx-graph>
          </div>
        </ng-container>

        <ng-template #flowTemplate>
          <ngx-graph class="chart-container" [links]="edges" [nodes]="nodes" [layoutSettings]="layoutSettings"
                     [autoCenter]="true" [layout]="layout" [curve]="curve" [center$]="center$" [draggingEnabled]="false"
                     [autoZoom]="autoZoom" [zoomLevel]="zoomLevel" [enableZoom]="true" [showMiniMap]="true" #graphWrapper>
            <ng-template #defsTemplate>
              <svg:marker id="arrow" viewBox="0 0 20 20" refX="20" refY="10" markerWidth="8" markerHeight="8"
                          orient="auto">
                <circle cx="10" cy="10" r="10" stroke="green" stroke-width="0" fill="gray" />
              </svg:marker>
              <svg:pattern id="diagonalHatch" patternUnits="userSpaceOnUse" width="4" height="4">
                <svg:path d="M-1,1 l2,-2
                       M0,4 l4,-4
                       M3,5 l2,-2" style="stroke:#eee; stroke-width:1" />
              </svg:pattern>
            </ng-template>

            <ng-template #nodeTemplate let-node>
              <svg:g class="node" *ngIf="node.category === 'NORMAL'">
                <svg:rect [attr.width]="node.dimension.width" [attr.height]="node.leaf ? 200 : 110"
                          fill="transparent" />
                <svg:foreignObject width="200" [attr.height]="node.leaf ? 200 : 110">
                  <xhtml:div class="cardContainer" style="text-align: center;"
                             xmlns="http://www.w3.org/1999/xhtml">
                    <img [attr.src]="ICONS[node.type]" x="75" y="0" height="50px" width="50px" />
                    <label class="remove-action" (click)="removeAction(node)">&times;</label>
                  </xhtml:div>
                  <xhtml:div class="cardContainer" (click)="editAction($event, node)"
                             style="background-color: transparent; padding: 5px 8px 20px 8px; margin-bottom: 15px; text-align: center;"
                             xmlns="http://www.w3.org/1999/xhtml">
                    <label class="name" style="margin: 0; font-size: 14px; font-weight: bold;">{{node.label}}</label>
                    <label class="name" style="margin: 0; font-size: 11px; color: #f28422; display: block;">{{node.period | duration}}</label>
                  </xhtml:div>
                  <ng-container *ngIf="node.leaf">
                    <xhtml:div
                      style="background-color: transparent; border-left: 2px dashed #aaa; width: 2px; height: 30px; margin-top: -15px; margin-left: auto; margin-right: auto;"
                      xmlns="http://www.w3.org/1999/xhtml">
                    </xhtml:div>
                    <xhtml:div class="cardContainer" (click)="addAction(node)"
                               style="margin-bottom: 5px; margin-top: 5px; text-align: center;"
                               xmlns="http://www.w3.org/1999/xhtml">
                      <img [attr.src]="'./assets/img/automations/automation_start.svg'" x="75" y="0" height="48px"
                           width="48px" />
                    </xhtml:div>
                  </ng-container>
                </svg:foreignObject>
              </svg:g>
              <svg:g class="node" *ngIf="node.category === 'CONDITION'">
                <svg:rect [attr.width]="node.dimension.width" [attr.height]="40"
                          fill="transparent" />
                <svg:foreignObject width="140" [attr.height]="40" style="overflow: visible">
                  <xhtml:div [class.trueCase]="node.condition.answer" [class.falseCase]="!node.condition.answer"
                             xmlns="http://www.w3.org/1999/xhtml">
                    <label class="name" style="margin: 0; font-size: 12px; font-weight: bold;">{{node.label}}</label>
                  </xhtml:div>
                  <ng-container *ngIf="node.leaf">
                    <xhtml:div
                      style="background-color: transparent; border-left: 2px dashed #aaa; width: 2px; height: 30px; margin-top: -15px; margin-left: auto; margin-right: auto;"
                      xmlns="http://www.w3.org/1999/xhtml">
                    </xhtml:div>
                    <xhtml:div class="cardContainer" (click)="addAction(node)"
                               style="margin-bottom: 5px; margin-top: 5px; text-align: center;"
                               xmlns="http://www.w3.org/1999/xhtml">
                      <img [attr.src]="'./assets/img/automations/automation_start.svg'" x="75" y="0" height="48px"
                           width="48px" />
                    </xhtml:div>
                  </ng-container>
                </svg:foreignObject>
              </svg:g>
            </ng-template>
            <ng-template #linkTemplate let-link>
              <svg:g class="edge">
                <svg:path class="line" stroke="#aaa" stroke-width="1" marker-start="url(#arrow)">
                </svg:path>
              </svg:g>
              <svg:g class="linkMidpoint" *ngIf="link.midPoint && !link.category"
                     [attr.transform]="'translate(' + (link.midPoint.x) + ',' + (link.midPoint.y) + ')'"
                     (click)="insertAction(link)">
                <ellipse rx="10" ry="10" fill='white' stroke='black' strokeWidth='2' />
                <svg:foreignObject width="20" height="20" x="-10" y="-10">
                  <xhtml:div xmlns="http://www.w3.org/1999/xhtml" style="height: 20px; text-align: center;">
                    <label style="margin: 0; font-size: 24px; line-height: 18px;">+</label>
                  </xhtml:div>
                </svg:foreignObject>
              </svg:g>
              <svg:g class="label" *ngIf="link.hasLabel && link.points && link.points[0]" [attr.transform]="'translate(' + (link.points[0].x - 40) + ',' + (link.points[0].y + 40) + ')'">
                <svg:rect [attr.width]="90" [attr.height]="60"
                          fill="transparent" />
                <svg:foreignObject width="90" [attr.height]="60">
                  <xhtml:div class="caseLabel"
                             style="background-color: transparent; text-align: center;"
                             xmlns="http://www.w3.org/1999/xhtml">
                    <label class="name" style="margin-top: 20px; margin-bottom: 0px; font-size: 14px;">{{CASE_ACTIONS[link.type]}}</label>
                    <label class="remove-link" (click)="removeCase(link)">&times;</label>
                  </xhtml:div>
                </svg:foreignObject>
              </svg:g>
            </ng-template>
          </ngx-graph>
        </ng-template>

        <!--  -->
      </div>
    </div>
  </div>
</div>
