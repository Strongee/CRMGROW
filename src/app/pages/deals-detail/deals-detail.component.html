<div class="page-content pt-0">
    <div class="d-flex deal-panel">
        <div class="deal-info-panel pr-3">
            <div class="v-center op-56 c-pointer mb-4 mt-3 back-button" (click)="backPage()">
                <i class="d-block i-icon i-triangle-left bgc-dark mr-2"></i>
                <span class="f-5 font-weight-bold">Back {{getPrevPage()}}</span>
            </div>
            <div class="v-center justify-content-between deal-main mb-3">
                <ng-container *ngIf="titleEditable; else displayTitleTemplate">
                  <div class="form-group mb-0 flex-grow-1 mr-3">
                    <input class="form-control title-input" [(ngModel)]="dealTitle" name="title" #title="ngModel" required (blur)="checkAndSave({keyCode: 13})" (keyup)="checkAndSave($event)" [disabled]="saving" [class.loading]="saving"/>
                  </div>
                </ng-container>
                <ng-template #displayTitleTemplate>
                  <div class="f-6 font-weight-bold mr-3" (click)="focusTitle()">
                    {{deal.main.title}}
                  </div>
                </ng-template>
                <div ngbDropdown class="ml-auto button-more p-0">
                    <div class="v-center btn btn-blue" ngbDropdownToggle>
                      <span class="f-6 font-weight-bold text-white c-pointer px-2">
                        Actions
                      </span>
                      <i class="d-block i-icon i-triangle-down bgc-white ml-2"></i>
                    </div>
                    <div ngbDropdownMenu class="light action-menu">
                      <button class="border-0 c-dark dropdown-item" (click)="openAppointmentDlg()">
                        <span class="ml-1 f-3 font-weight-bold">Create appointment</span>
                      </button>
                      <button class="border-0 c-dark dropdown-item" (click)="openGroupCallDlg()">
                        <span class="ml-1 f-3 font-weight-bold">Create group call</span>
                      </button>
                      <button class="border-0 c-dark dropdown-item" (click)="openSendEmail()">
                        <span class="ml-1 f-3 font-weight-bold">Send email</span>
                      </button>
                      <button class="border-0 c-dark dropdown-item" (click)="openTaskDlg()">
                        <span class="ml-1 f-3 font-weight-bold">Add task</span>
                      </button>
                      <button class="border-0 c-dark dropdown-item" (click)="openNoteDlg()">
                        <span class="ml-1 f-3 font-weight-bold">Add note</span>
                      </button>
                      <hr class="my-1">
                      <button class="border-0 dropdown-item" (click)="removeDeal()">
                        <span class="ml-1 f-3 font-weight-bold c-red">Delete</span>
                      </button>
                    </div>
                </div>
            </div>
            <div class="deal-stage mb-3">
                <div class="v-center">
                    <div class="f-6 fw-600 op-40 mr-3">
                        Stage
                    </div>
                    <div ngbDropdown>
                        <div class="v-center c-pointer" ngbDropdownToggle>
                            <span class="f-6 px-2 stage-title">
                                {{selectedStage?.title}}
                            </span>
                            <i class="d-block i-icon i-triangle-down bgc-dark ml-2"></i>
                        </div>
                        <div ngbDropdownMenu class="light">
                            <button class="border-0 c-dark dropdown-item"
                              *ngFor="let stage of stages; let position = index"
                              (click)="moveDeal(stage)"
                            >
                                <span class="ml-1 f-6">{{stage.title}}</span>
                            </button>
                        </div>
                    </div>
                </div>
                <div class="v-center justify-content-between mt-3 stage-status-items" style="height: 6px;" [class.loaded]="selectedStageId">
                    <div class="stage-status stage-{{index}} mr-1" *ngFor="let stage of stages; let index=index" [class.active]="stage._id === selectedStageId">
                    </div>
                </div>
            </div>
            <mat-accordion multi class="general-panels">
                <!-- Begin Deal Detail -->
                <mat-expansion-panel class="mat-elevation-z" hideToggle [expanded]="dealPanel">
                    <mat-expansion-panel-header (click)="dealPanel = !dealPanel">
                        <mat-panel-title>
                            <div class="v-center w-100">
                                <i class="i-icon i-triangle-right bgc-dark sm toggle-icon op-40"></i>
                                <span class="f-6 font-weight-bold ml-2">About this deal</span>
                                <button class="btn border-0 border-primary f-2 font-weight-bold c-blue ml-auto btn-sm v-center" (click)="editDeal()">
                                    <i class="i-icon i-edit d-block bgc-blue sm mr-1"></i>
                                    <span>Edit</span>
                                </button>
                            </div>
                        </mat-panel-title>
                    </mat-expansion-panel-header>
                    <div class="deal-detail">
                        <div class="row">
                            <div class="col-sm-6">
                                <span class="f-6 fw-600 op-40">Value</span>
                            </div>
                            <div class="col-sm-6">
                                <span class="f-6">{{deal.main.value ? '$' + deal.main.value : ''}}</span>
                            </div>
                        </div>
                        <div class="row mt-1">
                            <div class="col-sm-6">
                                <span class="f-6 fw-600 op-40">Stage</span>
                            </div>
                            <div class="col-sm-6">
                                <span class="f-6">{{selectedStage?.title}}</span>
                            </div>
                        </div>
                    </div>
                </mat-expansion-panel>
                <!-- End Deal Detail -->

                <!-- Begin Contacts Detail -->
                <mat-expansion-panel class="mat-elevation-z" hideToggle [expanded]="contactsPanel">
                    <mat-expansion-panel-header (click)="contactsPanel = !contactsPanel">
                        <mat-panel-title>
                            <div class="v-center w-100">
                                <i class="i-icon i-triangle-right bgc-dark sm toggle-icon op-40"></i>
                                <span class="f-6 font-weight-bold ml-2">Contacts ({{deal.contacts.length}})</span>
                                <button class="btn border-0 border-primary f-2 font-weight-bold c-blue ml-auto btn-sm v-center" (click)="addContact()">
                                    <i class="i-icon i-plus d-block bgc-blue sm mr-1"></i>
                                    <span>Add contact</span>
                                </button>
                            </div>
                        </mat-panel-title>
                    </mat-expansion-panel-header>
                    <div class="contact-detail mt-2" *ngFor="let contact of deal.contacts">
                        <div class="contact p-3 position-relative">
                            <div class="v-center pb-2 avatar-wrapper c-pointer" (click)="contactDetail(contact)">
                                <div class="v-center justify-content-center f-6 font-weight-bold text-white avatar">
                                    {{contact.avatarName}}
                                </div>
                                <div class="f-6 font-weight-bold name">
                                    {{contact.fullName}}
                                </div>
                            </div>
                            <div class="v-center mt-2">
                                <i class="d-block i-icon i-contact-phone bgc-dark mx-2"></i>
                                <span class="f-6">{{contact.cell_phone}}</span>
                            </div>
                            <div class="v-center mt-2">
                                <i class="d-block i-icon i-message bgc-dark mx-2"></i>
                                <span class="f-6">{{contact.email}}</span>
                            </div>
                            <div ngbDropdown class="contact-more c-pointer" placement="bottom-right">
                              <div class="c-pointer" ngbDropdownToggle>
                                <i class="d-block i-icon i-menu-more bgc-dark"></i>
                              </div>
                              <div ngbDropdownMenu class="light py-1">
                                  <button class="border-0 c-dark dropdown-item f-3 fw-600" (click)="removeContact(contact)">
                                      Remove contact
                                  </button>
                              </div>
                            </div>
                        </div>
                    </div>
                </mat-expansion-panel>
                <!-- End Contacts Detail -->
            </mat-accordion>
        </div>
        <div class="deal-action-panel flex-grow-1 position-relative">
          <div class="history-panel pt-3 pl-3 mt-2">
            <app-slide-tab [tabs]="tabs" [selected]="tab" (onChange)="changeTab($event)" type="plain" class="border-bottom pl-0 rounded-0">
            </app-slide-tab>
            <div class="history-list mt-3 position-relative">
              <div class="history-list-header v-center">
                <ng-container *ngIf="tab.id === 'all'">
                  <div ngbDropdown class="v-center">
                    <div class="v-center" ngbDropdownToggle>
                      <span class="f-3 font-weight-bold c-dark c-pointer mr-2">
                        {{activityType.id == 'all' ? 'All activity' : activityType.label}}
                      </span>
                      <i class="d-block i-icon i-triangle-down bgc-dark"></i>
                    </div>
                    <div ngbDropdownMenu class="light">
                      <div class="v-center justify-content-between dropdown-item" *ngFor="let tabItem of tabs" (click)="changeActivityTypes(tabItem)">
                        <div class="f-3 c-dark" [ngClass]="{'font-weight-bold': tabItem.id == activityType.id}" *ngIf="tabItem.id == 'all'; else others">
                          All activity
                        </div>
                        <ng-template #others>
                          <div class="f-3 c-dark" [ngClass]="{'font-weight-bold': tabItem.id == activityType.id}">
                            {{tabItem.label}}
                          </div>
                        </ng-template>
                        <div *ngIf="tabItem.id == activityType.id">
                          <i class="d-block i-icon i-check bgc-blue"></i>
                        </div>
                      </div>
                    </div>
                  </div>
                </ng-container>
                <ng-container *ngIf="tab.id === 'follow_ups'">
                  <div ngbDropdown class="v-center">
                    <div class="v-center" ngbDropdownToggle>
                      <span class="f-3 font-weight-bold c-dark c-pointer mr-2">
                        {{selectedTimeSort.label}}
                      </span>
                      <i class="d-block i-icon i-triangle-down bgc-dark"></i>
                    </div>
                    <div ngbDropdownMenu class="light">
                      <div class="v-center justify-content-between dropdown-item" *ngFor="let timeSort of timeSorts" (click)="changeSort(timeSort)">
                        <div class="f-3 c-dark" [ngClass]="{'font-weight-bold': timeSort.id == selectedTimeSort.id}">
                          {{timeSort.label}}
                        </div>
                        <div *ngIf="timeSort.id == selectedTimeSort.id">
                          <i class="d-block i-icon i-check bgc-blue"></i>
                        </div>
                      </div>
                    </div>
                  </div>
                </ng-container>
                <div class="v-center justify-content-end c-pointer ml-auto" (click)="openNoteDlg()" *ngIf="tab.id === 'notes' || (tab.id !== 'all' && activityType.id === 'notes')">
                  <span class="f-3 font-weight-bold c-blue mr-2">Add new note</span>
                  <i class="d-block i-icon i-plus bgc-blue"></i>
                </div>
                <div class="v-center justify-content-end c-pointer ml-auto" (click)="openSendEmail()" *ngIf="tab.id === 'emails' || (tab.id === 'all' && activityType.id === 'emails')">
                  <span class="f-3 font-weight-bold c-blue mr-2">Send email</span>
                  <i class="d-block i-icon i-plus bgc-blue"></i>
                </div>
                <div class="v-center justify-content-end c-pointer ml-auto" (click)="openSendText()" *ngIf="tab.id === 'texts' || (tab.id === 'all' && activityType.id === 'texts')">
                  <span class="f-3 font-weight-bold c-blue mr-2">Send text</span>
                  <i class="d-block i-icon i-plus bgc-blue"></i>
                </div>
                <div class="v-center justify-content-end c-pointer ml-auto" (click)="openAppointmentDlg()" *ngIf="tab.id === 'appointments' || (tab.id === 'all' && activityType.id === 'appointments')">
                  <span class="f-3 font-weight-bold c-blue mr-2">Create appointment</span>
                  <i class="d-block i-icon i-plus bgc-blue"></i>
                </div>
                <div class="v-center justify-content-end c-pointer ml-auto" (click)="openGroupCallDlg()" *ngIf="tab.id === 'team_calls' || (tab.id === 'all' && activityType.id === 'team_calls')">
                  <span class="f-3 font-weight-bold c-blue mr-2">Create group call</span>
                  <i class="d-block i-icon i-plus bgc-blue"></i>
                </div>
                <div class="v-center justify-content-end c-pointer ml-auto" (click)="openTaskDlg()" *ngIf="tab.id === 'follow_ups' || (tab.id === 'all' && activityType.id === 'follow_ups')">
                  <span class="f-3 font-weight-bold c-blue mr-2">Create task</span>
                  <i class="d-block i-icon i-plus bgc-blue"></i>
                </div>
              </div>
              <ng-container *ngIf="tab.id === 'all'; else detailsTemplate">
                <ng-container *ngFor="let activity of showingTimelines">
                  <ng-container [ngSwitch]="activity.type">
                    <div class="history-detail {{activity.type}}-detail p-3 mt-3" *ngSwitchCase="'follow_ups'">
                      <div class="v-center justify-content-between mb-3">
                        <div class="v-center">
                          <div class="history-icon mr-3"><i class="act-icon act-{{activity.type}} {{activity.activity_detail?.type}}" ></i></div>
                          <div class="f-6">
                            <span>{{activity.content}}</span>
                          </div>
                        </div>
                        <div class="v-center">
                          <span class="f-3 op-56 ml-auto">{{activity.created_at | date :'MMM d, hh:mm a'}}</span>
                          <div ngbDropdown class="button-more p-1 rounded" placement="bottom-right">
                            <a class="d-flex c-pointer no-carot" ngbDropdownToggle>
                              <i class="i-icon i-menu-more bg-dark" aria-hidden="true"></i>
                            </a>
                            <div ngbDropdownMenu class="light py-1">
                              <ng-container *ngIf="activity.activity_detail; else removedTaskAction">
                                <button
                                  class="v-center border-0 py-1 c-dark dropdown-item"
                                  *ngIf="!activity.activity_detail.status"
                                  (click)="editTask(activity)"
                                >
                                  <i class="i-icon i-edit bgc-dark ml-1" aria-hidden="true"></i>
                                  <span class="ml-3 f-2 font-weight-bold">Edit</span>
                                </button>
                                <button
                                  class="v-center border-0 py-1 c-dark dropdown-item"
                                  *ngIf="!activity.activity_detail.status"
                                  (click)="completeTask(activity)"
                                >
                                  <i class="i-icon i-check bgc-dark ml-1" aria-hidden="true"></i>
                                  <span class="ml-3 f-2 font-weight-bold">Complete</span>
                                </button>
                                <button
                                  class="v-center border-0 py-1 c-dark dropdown-item" 
                                  (click)="archiveTask(activity)"
                                >
                                  <i class="i-icon i-trash bgc-dark ml-1" aria-hidden="true"></i>
                                  <span class="ml-3 f-2 font-weight-bold">Delete</span>
                                </button>
                              </ng-container>
                              <ng-template #removedTaskAction>
                                <button
                                  class="v-center border-0 py-1 c-dark dropdown-item"
                                  (click)="removeActivity(activity)"
                                >
                                  <i class="i-icon i-edit bgc-dark ml-1" aria-hidden="true"></i>
                                  <span class="ml-3 f-2 font-weight-bold">Delete</span>
                                </button>
                              </ng-template>
                            </div>
                          </div>
                        </div>
                      </div>
                      <ng-container *ngIf="activity.activity_detail; else removedTaskTemplate">
                        <div class="main-history-item" [class.completed]="activity.content.indexOf('completed') !== -1">
                          <div class="v-center">
                            <div class="v-center justify-content-center c-pointer task-status" (click)="completeTask(activity)"
                              *ngIf="activity.content.indexOf('completed') === -1; else taskComplete">
                              <i class="i-icon i-check bgc-white"></i>
                            </div>
                            <ng-template #taskComplete>
                              <div class="v-center justify-content-center task-status">
                                <i class="i-icon i-check bgc-white"></i>
                              </div>
                            </ng-template>
                            <div class="f-6 font-weight-bold ml-3 content">
                              {{activity.activity_detail.content}}
                            </div>
                          </div>
                          <div class="v-center mt-3" *ngIf="activity.content.indexOf('completed') === -1">
                            <div class="time">
                              <div class="f-4 fw-600 op-40">
                                Due date
                              </div>
                              <div class="v-center mt-1">
                                <i class="d-block i-icon i-calendar bgc-dark mr-2"></i>
                                <span class="f-4">{{activity.activity_detail.due_date | date: 'MM/dd/yyyy'}} at {{activity.activity_detail.due_date | date: 'shortTime'}}</span>
                              </div>
                            </div>
                            <div class="type ml-5">
                              <div class="f-4 fw-600 op-40">
                                Type
                              </div>
                              <div class="v-center mt-1">
                                <ng-container [ngSwitch]="activity.activity_detail.type">
                                  <i class="d-block i-icon i-task bgc-dark mr-2" *ngSwitchCase="'task'"></i>
                                  <i class="d-block i-icon i-phone bgc-dark mr-2" *ngSwitchCase="'call'"></i>
                                  <i class="d-block i-icon i-lunch bgc-dark mr-2" *ngSwitchCase="'meeting'"></i>
                                  <i class="d-block i-icon i-message bgc-dark mr-2" *ngSwitchCase="'email'"></i>
                                  <i class="d-block i-icon i-video bgc-dark mr-2" *ngSwitchCase="'material'"></i>
                                </ng-container>
                                <span class="f-4 text-capitalize">{{activity.activity_detail.type}}</span>
                              </div>
                            </div>
                          </div>
                        </div>
                      </ng-container>
                      <ng-template #removedTaskTemplate>
                        <div class="d-flex">
                          <mat-icon class="mr-2">warning</mat-icon>
                          <span>Can't see the detail as it is deleted.</span>
                        </div>
                      </ng-template>
                      <div class="related-history-item" *ngIf="groupActions[activity.group_id].length > 1">
                        <app-accordion [showIndicator]="show" [hideIndicator]="hide">
                          <ng-template #show>
                            <div class="content">
                              <div class="f-3 fw-600 c-blue mt-1">
                                See details
                              </div>      
                            </div>
                          </ng-template>
                          <ng-template #hide>
                            <div class="content w-100">
                              <ng-container *ngFor="let detailActivity of groupActions[activity.group_id]; let i = index;">
                                <div class="d-flex mb-1">
                                  <div class="mr-2 font-weight-bold"># {{groupActions[activity.group_id].length - i}}</div>
                                  <div class="mr-2 text-capitalize rounded-pill bgc-green-weak text-white px-3">{{detailActivity.content}}</div>
                                  <div class="ml-auto c-trans56">{{detailActivity.created_at | date: 'MMM dd, hh:mm a'}}</div>
                                </div>
                              </ng-container>
                              <div class="f-3 fw-600 c-blue mt-1">
                                Close
                              </div>
                            </div>
                          </ng-template>
                        </app-accordion>
                      </div>
                    </div>
                    
                    <div class="history-detail {{activity.type}}-detail p-3 mt-3" *ngSwitchCase="'notes'">
                      <div class="v-center justify-content-between mb-3">
                        <div class="v-center">
                          <div class="history-icon mr-3"><i class="act-icon act-{{activity.type}} {{activity.activity_detail?.type}}" ></i></div>
                          <div class="f-6">
                            <span>{{activity.content}}</span>
                          </div>
                        </div>
                        <div class="v-center">
                          <span class="f-3 op-56 ml-auto">{{activity.created_at | date :'MMM d, hh:mm a'}}</span>
                          <div ngbDropdown class="button-more p-1 rounded" placement="bottom-right">
                            <a class="d-flex c-pointer no-carot" ngbDropdownToggle>
                              <i class="i-icon i-menu-more bg-dark" aria-hidden="true"></i>
                            </a>
                            <div ngbDropdownMenu class="light py-1">
                              <ng-container *ngIf="activity.activity_detail; else removedNoteAction">
                                <button class="v-center border-0 py-1 c-dark dropdown-item" (click)="updateNote(activity)">
                                  <i class="i-icon i-edit bgc-dark ml-1" aria-hidden="true"></i>
                                  <span class="ml-3 f-2 font-weight-bold">Edit</span>
                                </button>
                                <button class="v-center border-0 py-1 c-dark dropdown-item" (click)="deleteNote(activity)">
                                  <i class="i-icon i-trash bgc-dark ml-1" aria-hidden="true"></i>
                                  <span class="ml-3 f-2 font-weight-bold">Delete</span>
                                </button>
                              </ng-container>
                              <ng-template #removedNoteAction>
                                <button class="v-center border-0 py-1 c-dark dropdown-item" (click)="removeActivity(activity)">
                                  <i class="i-icon i-trash bgc-dark ml-1" aria-hidden="true"></i>
                                  <span class="ml-3 f-2 font-weight-bold">Delete</span>
                                </button>
                              </ng-template>
                            </div>
                          </div>
                        </div>
                      </div>
                      <ng-container *ngIf="activity.activity_detail; else removedNoteTemplate">
                        <div class="main-history-item">
                          <app-accordion [showIndicator]="show" [hideIndicator]="hide" *ngIf="activity.activity_detail.content">
                            <ng-template #show>
                              <div class="content f-6 position-relative">
                                <div class="note-content">{{activity.activity_detail.content || 'No Content Note' | stripTags | shorten: 300: '...' }}</div>
                                <div class="gradient-bottom"></div>
                                <div class="f-3 fw-600 c-blue mt-1">
                                  Expand
                                </div>
                              </div>
                            </ng-template>
                            <ng-template #hide>
                              <div class="content">
                                <div class="f-6 note-content opened">{{activity.activity_detail.content}}</div>
                                <div class="f-3 fw-600 c-blue mt-1">
                                  Collapse
                                </div>
                              </div>
                            </ng-template>
                          </app-accordion>
                        </div>
                      </ng-container>
                      <ng-template #removedNoteTemplate>
                        <div class="d-flex">
                          <mat-icon class="mr-2">warning</mat-icon>
                          <span>Can't see the detail as it is deleted.</span>
                        </div>
                      </ng-template>
                    </div>

                    <div class="history-detail {{activity.type}}-detail p-3 mt-3" *ngSwitchCase="'emails'">
                      <div class="v-center justify-content-between mb-3">
                        <div class="v-center">
                          <div class="history-icon mr-3"><i class="act-icon act-{{activity.type}} {{activity.activity_detail?.type}}" ></i></div>
                          <div class="f-6">
                            <span>{{activity.content}}</span>
                          </div>
                        </div>
                        <div class="v-center ml-auto">
                          <span class="f-3 op-56">{{activity.created_at | date :'MMM d, hh:mm a'}}</span>
                        </div>
                      </div>
                      <ng-container *ngIf="activity.activity_detail;">
                        <div class="main-history-item">
                          <ng-container *ngIf="groupActions[activity.group_id].length === 1; else multiEmailHistory">
                            <div class="summary position-relative">
                              <div class="title f-6 font-weight-bold">
                                {{details[activity.emails]?.subject}}
                              </div>
                              <div class="f-6 detail-content" [innerHTML]="convertContent(details[activity.emails]?.content)"></div>
                              <div class="gradient-bottom"></div>
                              <div class="c-blue mt-1 f-3 fw-600 c-pointer" (click)="showDetail($event)">Expand</div>
                            </div>
                            <div class="detail">
                              <div class="title f-6 font-weight-bold">
                                {{details[activity.emails]?.subject}}
                              </div>
                              <div class="f-6" [innerHTML]="details[activity.emails]?.content || 'No Content'"></div>
                              <div class="c-blue mt-1 f-3 fw-600 c-pointer" (click)="hideDetail($event)">Collapse</div>
                            </div>
                          </ng-container>
                          <ng-template #multiEmailHistory>
                            <div class="summary position-relative">
                              <div class="title f-6 font-weight-bold">
                                {{details[activity.emails]?.subject}}
                              </div>
                              <div class="f-6 detail-content" [innerHTML]="convertContent(details[activity.emails]?.content)"></div>
                              <div class="gradient-bottom"></div>
                              <div class="c-blue mt-1 f-3 fw-600 c-pointer" (click)="showDetail($event)">Expand</div>
                            </div>
                            <div class="detail">
                              <div class="title f-6 font-weight-bold">
                                {{details[activity.emails]?.subject}}
                              </div>
                              <div class="f-6 mb-2" [innerHTML]="details[activity.emails]?.content || 'No Content'"></div>
                              <table class="table">
                                <thead>
                                  <tr>
                                    <th class="session-col">session</th>
                                    <th class="duration-col">duration</th>
                                    <th class="date-col">date</th>
                                  </tr>
                                </thead>
                                <tbody>
                                  <tr *ngFor="let detailActivity of groupActions[activity.group_id]; let i = index;">
                                    <td class="session-col">
                                      <span class="f-3 font-weight-bold">#{{groupActions[activity.group_id].length - i}}</span>
                                      <span class="f-3 font-weight-bold ml-2">{{detailActivity.content}}</span>
                                    </td>
                                    <td class="duration-col">{{details[activity.emails]?.duration || '' | timeDuration}}</td>
                                    <td class="date-col">
                                      <div class="f-3 font-weight-bold text-uppercase px-2 py-1 c-pointer" ngbTooltip="{{detailActivity.created_at | date: 'MMMM dd yyyy, hh:mm a'}}">
                                        {{detailActivity.created_at | date: 'MMMM dd'}}
                                      </div>
                                    </td>
                                  </tr>
                                </tbody>
                              </table>
                              <div class="c-blue mt-2 f-3 fw-600 c-pointer" (click)="hideDetail($event)">Collapse</div>
                            </div>
                          </ng-template>
                        </div>
                      </ng-container>
                    </div>

                    <div class="history-detail {{activity.type}}-detail p-3 mt-3" *ngSwitchCase="'texts'">
                      
                    </div>

                    <div class="history-detail {{activity.type}}-detail p-3 mt-3" *ngSwitchCase="'team_calls'">
                      <div class="v-center justify-content-between mb-3">
                        <div class="v-center">
                          <div class="history-icon mr-3"><i class="act-icon act-{{activity.type}} {{activity.activity_detail?.type}}" ></i></div>
                          <div class="f-6">
                            <span>{{activity.content}}</span>
                          </div>
                        </div>
                        <!-- <div class="v-center">
                          <span class="f-3 op-56 ml-auto">{{activity.created_at | date :'MMM d, hh:mm a'}}</span>
                          <div ngbDropdown class="button-more p-1 rounded" placement="bottom-right">
                            <a class="d-flex c-pointer no-carot" ngbDropdownToggle>
                              <i class="i-icon i-menu-more bg-dark" aria-hidden="true"></i>
                            </a>
                            <div ngbDropdownMenu class="light py-1">
                              <button class="v-center border-0 py-1 c-dark dropdown-item" (click)="removeActivity(activity)">
                                <i class="i-icon i-trash bgc-dark ml-1" aria-hidden="true"></i>
                                <span class="ml-3 f-2 font-weight-bold">Delete activity</span>
                              </button>
                            </div>
                          </div>
                        </div> -->
                      </div>
                      <ng-container *ngIf="activity.activity_detail; else removedGroupCallTemplate">
                        <div class="main-history-item">
                          <app-accordion [showIndicator]="show" [hideIndicator]="hide">
                            <ng-template #show>
                              <div class="content f-6 position-relative">
                                <div class="font-weight-bold">
                                  {{activity.activity_detail.subject}}
                                </div>
                                <div class="call-status mb-3">
                                  <div class="tag {{activity.activity_detail.status}}">{{activity.activity_detail.status}}</div>
                                  <ng-container *ngIf="activity.activity_detail.status === 'planned'">
                                  <span class="f-3"> on </span><span class="time f-3 font-weight-bold">{{activity.activity_detail.confirmed_at | date :'MMM d, hh:mm a'}}</span>
                                  </ng-container>
                                </div>
                                <div class="f-6" [innerHTML]="activity.activity_detail.description || '' | stripTags | shorten: 300: '...'"></div>
                                <div class="gradient-bottom"></div>
                                <div class="f-3 fw-600 c-blue mt-1">
                                  Expand
                                </div>
                              </div>
                            </ng-template>
                            <ng-template #hide>
                              <div class="content">
                                <div class="f-6 font-weight-bold">
                                  {{activity.activity_detail.subject}}
                                </div>
                                <div class="call-status mb-3">
                                  <div class="tag {{activity.activity_detail.status}}">{{activity.activity_detail.status}}</div>
                                  <ng-container *ngIf="activity.activity_detail.status === 'planned'">
                                    on <span class="time">{{activity.activity_detail.confirmed_at | date :'MMM d, hh:mm a'}}</span>
                                  </ng-container>
                                </div>
                                <div class="f-6" [innerHTML]="activity.activity_detail.description || ''"></div>
                                <div class="f-3 fw-600 c-blue mt-1">
                                  Collapse
                                </div>
                              </div>
                            </ng-template>
                          </app-accordion>
                          <div class="v-center mt-3">
                            <div class="contacts">
                              <div class="f-4 fw-600 op-40">
                                Contacts
                              </div>
                              <div class="v-center mt-1">
                                <i class="d-block i-icon i-lunch bgc-dark mr-2"></i>
                                <span class="f-4">{{activity.activity_detail.contacts?.length || 0}}</span>
                              </div>
                            </div>
                            <div class="time ml-5">
                              <div class="f-4 fw-600 op-40">
                                Duration
                              </div>
                              <div class="v-center mt-1">
                                <i class="d-block i-icon i-timer bgc-dark mr-2"></i>
                                <span class="f-4">{{activity.activity_detail.duration}}mins</span>
                              </div>
                            </div>
                          </div>
                          <div class="mt-4" *ngIf="activity.activity_detail.desired_at">
                            <div class="f-4 fw-600 op-40">
                              Desired time
                            </div>
                            <div class="f-3 mt-1 fw-600">
                              {{activity.activity_detail.desired_at | date :'MMM d, hh:mm a'}}
                            </div>
                          </div>
                          <div class="mt-4" *ngIf="activity.activity_detail.proposed_at && activity.activity_detail.proposed_at.length">
                            <div class="f-4 fw-600 op-40">
                              Proposed times
                            </div>
                            <div class="f-3 mt-1 fw-600" *ngFor="let time of activity.activity_detail.proposed_at">
                              {{time | date :'MMM d, hh:mm a'}}
                            </div>
                          </div>
                          <div class="mt-4" *ngIf="activity.activity_detail.schedule_link">
                            <div class="f-4 fw-600 op-40">
                              Calendar Link
                            </div>
                            <div class="f-3 mt-1 c-blue">
                              {{activity.activity_detail.schedule_link}}
                            </div>
                          </div>
                        </div>
                      </ng-container>  
                      <ng-template #removedAppointmentTemplate>
                        <div class="d-flex">
                          <mat-icon class="mr-2">warning</mat-icon>
                          <span>Can't see the detail as it is deleted.</span>
                        </div>
                      </ng-template>
                    </div>

                    <div class="history-detail {{activity.type}}-detail p-3 mt-3" *ngSwitchCase="'appointments'">
                      <div class="v-center justify-content-between mb-3">
                        <div class="v-center">
                          <div class="history-icon mr-3"><i class="act-icon act-{{activity.type}} {{activity.activity_detail?.type}}" ></i></div>
                          <div class="f-6">
                            <span>{{activity.content}}</span>
                          </div>
                        </div>
                        <div class="v-center">
                          <span class="f-3 op-56 ml-auto">{{activity.created_at | date :'MMM d, hh:mm a'}}</span>
                          <div ngbDropdown class="button-more p-1 rounded" placement="bottom-right">
                            <a class="d-flex c-pointer no-carot" ngbDropdownToggle>
                              <i class="i-icon i-menu-more bg-dark" aria-hidden="true"></i>
                            </a>
                            <div ngbDropdownMenu class="light py-1">
                              <button class="v-center border-0 py-1 c-dark dropdown-item" (click)="editAppointment(activity)">
                                <i class="i-icon i-edit bgc-dark ml-1" aria-hidden="true"></i>
                                <span class="ml-3 f-2 font-weight-bold">Edit Appointment</span>
                              </button>
                              <button class="v-center border-0 py-1 c-dark dropdown-item" (click)="removeAppointment(activity)">
                                <i class="i-icon i-trash bgc-dark ml-1" aria-hidden="true"></i>
                                <span class="ml-3 f-2 font-weight-bold">Remove Appointment</span>
                              </button>
                            </div>
                          </div>
                        </div>
                      </div>
                      <ng-container *ngIf="activity.activity_detail; else removedAppointmentTemplate">
                        <div class="main-history-item">
                          <app-accordion [showIndicator]="show" [hideIndicator]="hide">
                            <ng-template #show>
                              <div class="content f-6 position-relative">
                                <div class="font-weight-bold">
                                  {{activity.activity_detail.title}}
                                </div>
                                <div class="f-6" [innerHTML]="activity.activity_detail.description || '' | stripTags | shorten: 300: '...'"></div>
                                <div class="gradient-bottom"></div>
                                <div class="f-3 fw-600 c-blue mt-1">
                                  Expand
                                </div>      
                              </div>
                            </ng-template>
                            <ng-template #hide>
                              <div class="content">
                                <div class="f-6 font-weight-bold">
                                  {{activity.activity_detail.title}}
                                </div>
                                <div class="f-6" [innerHTML]="activity.activity_detail.description || ''"></div>
                                <div class="f-3 fw-600 c-blue mt-1">
                                  Collapse
                                </div>
                              </div>
                            </ng-template>
                          </app-accordion>
                          <div class="v-center mt-3">
                            <div class="date">
                              <div class="f-4 fw-600 op-40">
                                Date
                              </div>
                              <div class="v-center mt-1">
                                <i class="d-block i-icon i-calendar bgc-dark mr-2"></i>
                                <span class="f-4">{{activity.activity_detail.due_start | date: 'MM/dd/yyyy'}}</span>
                              </div>
                            </div>
                            <div class="time ml-5">
                              <div class="f-4 fw-600 op-40">
                                Time
                              </div>
                              <div class="v-center mt-1">
                                <i class="d-block i-icon i-timer bgc-dark mr-2"></i>
                                <span class="f-4">{{getTime(activity.activity_detail.due_start, activity.activity_detail.due_end)}}</span>
                              </div>
                            </div>
                            <div class="location ml-5">
                              <div class="f-4 fw-600 op-40">
                                Location
                              </div>
                              <div class="v-center mt-1">
                                <i class="d-block i-icon i-location bgc-dark mr-2"></i>
                                <span class="f-4">{{activity.activity_detail.location}}</span>
                              </div>
                            </div>
                          </div>
                          <div class="mt-4" *ngIf="activity.activity_detail.zoom_link">
                            <div class="f-4 fw-600 op-40">
                              Zoom meeting
                            </div>
                            <div class="f-4 c-blue mt-1">
                              {{activity.activity_detail.zoom_link}}
                            </div>
                          </div>
                        </div>
                      </ng-container>  
                      <ng-template #removedAppointmentTemplate>
                        <div class="d-flex">
                          <mat-icon class="mr-2">warning</mat-icon>
                          <span>Can't see the detail as it is deleted.</span>
                        </div>
                      </ng-template>
                    </div>
                  </ng-container>
                </ng-container>

                <ng-container *ngIf="activityType.id !== 'all' && !activityCount[activityType.id]">
                  <div class="empty-list">
                    <div class="object-icon v-center">
                      <i class="i-icon i-{{activityType.id}} d-block bgc-dark"></i>
                    </div>
                    <h4 class="font-weight-bold mt-4 mb-3">
                      There are no {{activityType.label | lowercase}} with this contact yet.
                    </h4>
                  </div>
                </ng-container>
                
                <div class="history-detail p-3 mt-3" *ngIf="activityType.id === 'all'">
                  <div class="v-center justify-content-between mb-3">
                    <div class="v-center">
                      <div class="history-icon mr-3"><i class="act-icon act-deals"></i></div>
                      <div class="f-6">
                        <span>Deal created</span>
                      </div>
                    </div>
                    <div class="v-center ml-auto">
                      <span class="f-3 op-56 ml-auto">{{deal.main.created_at | date: 'MMM dd, hh:mm a'}}</span>
                    </div>
                  </div>
                  <div class="f-3 font-weight-bold ml-4 pl-2">
                    This deal was created
                  </div>
                </div>
              </ng-container>
              <ng-template #detailsTemplate>
                <ng-container *ngIf="showingDetails.length; else emptyDetails">
                  <ng-container *ngFor="let detail of showingDetails">
                    <ng-container [ngSwitch]="tab.id">
                      <div class="history-detail notes-detail p-3 mt-3" *ngSwitchCase="'notes'">
                        <div class="v-center justify-content-between mb-3">
                          <div class="history-icon mr-3"><i class="act-icon act-notes"></i></div>
                          <div class="">note</div>
                          <div class="ml-auto f-3 op-56">
                            {{detail.created_at | date :'MMM d, hh:mm a'}}
                          </div>
                          <div ngbDropdown class="button-more p-1 rounded" placement="bottom-right">
                            <a class="d-flex c-pointer no-carot" ngbDropdownToggle>
                              <i class="i-icon i-menu-more bg-dark" aria-hidden="true"></i>
                            </a>
                            <div ngbDropdownMenu class="light py-1">
                              <button
                                class="v-center border-0 py-1 c-dark dropdown-item"
                                (click)="updateNoteDetail(detail)"
                              >
                                <i class="i-icon i-edit bgc-dark ml-1" aria-hidden="true"></i>
                                <span class="ml-3 f-2 font-weight-bold">Edit</span>
                              </button>
                              <button
                                class="v-center border-0 py-1 c-dark dropdown-item"
                                (click)="deleteNoteDetail(detail)"
                              >
                                <i class="i-icon i-trash bgc-dark ml-1" aria-hidden="true"></i>
                                <span class="ml-3 f-2 font-weight-bold">Delete</span>
                              </button>
                            </div>
                          </div>
                        </div>
                        <div class="main-history-item">
                          <app-accordion [showIndicator]="show" [hideIndicator]="hide">
                            <ng-template #show>
                              <div class="content f-6 position-relative">
                                <div class="note-content">{{detail.content || '' | stripTags | shorten: 300: '...' }}</div>
                                <div class="gradient-bottom"></div>
                                <div class="f-3 fw-600 c-blue mt-1">
                                  Expand
                                </div>
                              </div>
                            </ng-template>
                            <ng-template #hide>
                              <div class="content">
                                <div class="f-6 note-content opened">{{detail.content}}</div>
                                <div class="f-3 fw-600 c-blue mt-1">
                                  Collapse
                                </div>
                              </div>
                            </ng-template>
                          </app-accordion>
                        </div>
                      </div>
                      <div class="history-detail emails-detail p-3 mt-3" *ngSwitchCase="'emails'">
                        <div class="v-center justify-content-between mb-3">
                          <div class="history-icon mr-3"><i class="act-icon act-{{detail.data_type}}"></i></div>
                          <div class="">
                            <ng-container [ngSwitch]="detail.data_type">
                              <span *ngSwitchCase="'emails'">email</span>
                              <span *ngSwitchCase="'videos'">video</span>
                              <span *ngSwitchCase="'pdfs'">pdf</span>
                              <span *ngSwitchCase="'images'">image</span>
                            </ng-container>
                          </div>
                          <div class="ml-auto f-3 op-56">
                            {{detail.created_at | date :'MMM d, hh:mm a'}}
                          </div>
                          <div ngbDropdown class="button-more p-1 rounded" placement="bottom-right">
                            <a class="d-flex c-pointer no-carot" ngbDropdownToggle>
                              <i class="i-icon i-menu-more bg-dark" aria-hidden="true"></i>
                            </a>
                            <div ngbDropdownMenu class="light py-1">
                            </div>
                          </div>
                        </div>
                        <div class="main-history-item">
                          <ng-container>
                            <div class="summary position-relative">
                              <div class="title f-6 font-weight-bold">
                                {{detail.data_type === 'emails' ? detail.subject : detail.title}}
                              </div>
                              <div class="f-6 detail-content" [innerHTML]="convertContent(detail.data_type === 'emails' ? detail.content : detail.description)"></div>
                              <div class="gradient-bottom"></div>
                              <div class="c-blue mt-1 f-3 fw-600 c-pointer" (click)="showDetail($event)">Expand</div>
                            </div>
                            <div class="detail">
                              <div class="title f-6 font-weight-bold">
                                {{detail.data_type === 'emails' ? detail.subject : detail.title}}
                              </div>
                              <div class="f-6 mb-2" [innerHTML]="(detail.data_type === 'emails' ? detail.content : detail.description) || ''"></div>
                              <table class="table"
                                *ngIf="(detail.data_type === 'emails' && sendActions[detail._id].length > 1) || (detail.data_type !== 'emails' && sendActions[detail.group_id].length > 1)">
                                <thead>
                                  <tr>
                                    <th class="session-col">session</th>
                                    <th class="duration-col"></th>
                                    <th class="date-col">date</th>
                                  </tr>
                                </thead>
                                <tbody>
                                  <tr *ngFor="let detailActivity of (detail.data_type === 'emails' ? sendActions[detail._id] : sendActions[detail.group_id]); let i = index;">
                                    <td class="session-col">
                                      <span class="f-3 font-weight-bold">#{{(detail.data_type === 'emails' ? sendActions[detail._id].length : sendActions[detail.group_id].length) - i}}</span>
                                      <span class="f-3 font-weight-bold ml-2">{{detailActivity.content}}</span>
                                    </td>
                                    <td class="duration-col">
                                      <span class="f-3 font-weight-bold">{{(detailActivity.activity_detail && detailActivity.activity_detail.duration ? detailActivity.activity_detail.duration + 's' : '') | timeDuration}}</span>
                                    </td>
                                    <td class="date-col">
                                      <div class="f-3 font-weight-bold text-uppercase px-2 py-1 c-pointer" ngbTooltip="{{detailActivity.created_at | date: 'MMMM dd yyyy, hh:mm a'}}">
                                        {{detailActivity.created_at | date: 'MMMM dd'}}
                                      </div>
                                    </td>
                                  </tr>
                                </tbody>
                              </table>
                              <div class="c-blue mt-2 f-3 fw-600 c-pointer" (click)="hideDetail($event)">Collapse</div>
                            </div>
                          </ng-container>
                        </div>
                      </div>
                      <div class="history-detail texts-detail p-3 mt-3" *ngSwitchCase="'texts'">
    
                      </div>
    
                      <div class="history-detail appointments-detail p-3 mt-3" *ngSwitchCase="'appointments'">
                        <div class="v-center justify-content-between mb-3">
                          <div class="history-icon mr-3"><i class="act-icon act-appointments"></i></div>
                          <div class="">appointment</div>
                          <div class="ml-auto f-3 op-56">
                            {{detail.created_at | date :'MMM d, hh:mm a'}}
                          </div>
                          <div ngbDropdown class="button-more p-1 rounded" placement="bottom-right">
                            <a class="d-flex c-pointer no-carot" ngbDropdownToggle>
                              <i class="i-icon i-menu-more bg-dark" aria-hidden="true"></i>
                            </a>
                            <div ngbDropdownMenu class="light py-1">
                              <button class="v-center border-0 py-1 c-dark dropdown-item" (click)="editAppointment(detail, true)">
                                <i class="i-icon i-edit bgc-dark ml-1" aria-hidden="true"></i>
                                <span class="ml-3 f-2 font-weight-bold">Edit Appointment</span>
                              </button>
                              <button class="v-center border-0 py-1 c-dark dropdown-item" (click)="removeAppointment(detail, true)">
                                <i class="i-icon i-trash bgc-dark ml-1" aria-hidden="true"></i>
                                <span class="ml-3 f-2 font-weight-bold">Remove Appointment</span>
                              </button>
                            </div>
                          </div>
                        </div>
                        <div class="main-history-item">
                          <app-accordion [showIndicator]="show" [hideIndicator]="hide">
                            <ng-template #show>
                              <div class="content f-6 position-relative">
                                <div class="font-weight-bold">
                                  {{detail.title}}
                                </div>
                                <div class="f-6" [innerHTML]="detail.description || '' | stripTags | shorten: 300: '...'"></div>
                                <div class="gradient-bottom"></div>
                                <div class="f-3 fw-600 c-blue mt-1">
                                  Expand
                                </div>      
                              </div>
                            </ng-template>
                            <ng-template #hide>
                              <div class="content">
                                <div class="f-6 font-weight-bold">
                                  {{detail.title}}
                                </div>
                                <div class="f-6" [innerHTML]="detail.description || ''"></div>
                                <div class="f-3 fw-600 c-blue mt-1">
                                  Collapse
                                </div>
                              </div>
                            </ng-template>
                          </app-accordion>
                          <div class="v-center mt-3">
                            <div class="date">
                              <div class="f-4 fw-600 op-40">
                                Date
                              </div>
                              <div class="v-center mt-1">
                                <i class="d-block i-icon i-calendar bgc-dark mr-2"></i>
                                <span class="f-4">{{detail.due_start | date: 'MM/dd/yyyy'}}</span>
                              </div>
                            </div>
                            <div class="time ml-5">
                              <div class="f-4 fw-600 op-40">
                                Time
                              </div>
                              <div class="v-center mt-1">
                                <i class="d-block i-icon i-timer bgc-dark mr-2"></i>
                                <span class="f-4">{{getTime(detail.due_start,detail.due_end)}}</span>
                              </div>
                            </div>
                            <div class="location ml-5">
                              <div class="f-4 fw-600 op-40">
                                Location
                              </div>
                              <div class="v-center mt-1">
                                <i class="d-block i-icon i-location bgc-dark mr-2"></i>
                                <span class="f-4">{{detail.location}}</span>
                              </div>
                            </div>
                          </div>
                          <div class="mt-4" *ngIf="detail.zoom_link">
                            <div class="f-4 fw-600 op-40">
                              Zoom meeting
                            </div>
                            <div class="f-4 c-blue mt-1">
                              {{detail.zoom_link}}
                            </div>
                          </div>
                        </div>
                      </div>
                      
                      <div class="history-detail group_calls-detail p-3 mt-3" *ngSwitchCase="'team_calls'">
                        <div class="v-center justify-content-between mb-3">
                          <div class="history-icon mr-3"><i class="act-icon act-team_calls"></i></div>
                          <div class="">group call</div>
                          <div class="ml-auto f-3 op-56">
                            {{detail.created_at | date :'MMM d, hh:mm a'}}
                          </div>
                        </div>
    
                        <div class="main-history-item">
                          <app-accordion [showIndicator]="show" [hideIndicator]="hide">
                            <ng-template #show>
                              <div class="content f-6 position-relative">
                                <div class="font-weight-bold">
                                  {{detail.subject}}
                                </div>
                                <div class="call-status mb-3">
                                  <div class="tag {{detail.status}}">{{detail.status}}</div>
                                  <ng-container *ngIf="detail.status === 'planned'">
                                  <span class="f-3"> on </span><span class="time f-3 font-weight-bold">{{detail.confirmed_at | date :'MMM d, hh:mm a'}}</span>
                                  </ng-container>
                                </div>
                                <div class="f-6" [innerHTML]="detail.description || '' | stripTags | shorten: 300: '...'"></div>
                                <div class="gradient-bottom"></div>
                                <div class="f-3 fw-600 c-blue mt-1">
                                  Expand
                                </div>
                              </div>
                            </ng-template>
                            <ng-template #hide>
                              <div class="content">
                                <div class="f-6 font-weight-bold">
                                  {{detail.subject}}
                                </div>
                                <div class="call-status mb-3">
                                  <div class="tag {{detail.status}}">{{detail.status}}</div>
                                  <ng-container *ngIf="detail.status === 'planned'">
                                    on <span class="time">{{detail.confirmed_at | date :'MMM d, hh:mm a'}}</span>
                                  </ng-container>
                                </div>
                                <div class="f-6" [innerHTML]="detail.description || ''"></div>
                                <div class="f-3 fw-600 c-blue mt-1">
                                  Collapse
                                </div>
                              </div>
                            </ng-template>
                          </app-accordion>
                          <div class="v-center mt-3">
                            <div class="contacts">
                              <div class="f-4 fw-600 op-40">
                                Contacts
                              </div>
                              <div class="v-center mt-1">
                                <i class="d-block i-icon i-lunch bgc-dark mr-2"></i>
                                <span class="f-4">{{detail.contacts?.length || 0}}</span>
                              </div>
                            </div>
                            <div class="time ml-5">
                              <div class="f-4 fw-600 op-40">
                                Duration
                              </div>
                              <div class="v-center mt-1">
                                <i class="d-block i-icon i-timer bgc-dark mr-2"></i>
                                <span class="f-4">{{detail.duration}}mins</span>
                              </div>
                            </div>
                          </div>
                          <div class="mt-4" *ngIf="detail.desired_at">
                            <div class="f-4 fw-600 op-40">
                              Desired time
                            </div>
                            <div class="f-3 mt-1 fw-600">
                              {{detail.desired_at | date :'MMM d, hh:mm a'}}
                            </div>
                          </div>
                          <div class="mt-4" *ngIf="detail.proposed_at && detail.proposed_at.length">
                            <div class="f-4 fw-600 op-40">
                              Proposed times
                            </div>
                            <div class="f-3 mt-1 fw-600" *ngFor="let time of detail.proposed_at">
                              {{time | date :'MMM d, hh:mm a'}}
                            </div>
                          </div>
                          <div class="mt-4" *ngIf="detail.schedule_link">
                            <div class="f-4 fw-600 op-40">
                              Calendar Link
                            </div>
                            <div class="f-3 mt-1 c-blue">
                              {{detail.schedule_link}}
                            </div>
                          </div>
                        </div>
                      </div>
                      
                      <div class="history-detail follow_ups-detail p-3 mt-3" *ngSwitchCase="'follow_ups'">
                        <div class="v-center justify-content-between mb-3">
                          <div class="history-icon mr-3"><i class="act-icon act-follow_ups"></i></div>
                          <div class="">task</div>
                          <div class="ml-auto f-3 op-56">
                            {{detail.created_at | date :'MMM d, hh:mm a'}}
                          </div>
                          <div ngbDropdown class="button-more p-1 rounded" placement="bottom-right">
                            <a class="d-flex c-pointer no-carot" ngbDropdownToggle>
                              <i class="i-icon i-menu-more bg-dark" aria-hidden="true"></i>
                            </a>
                            <div ngbDropdownMenu class="light py-1">
                              <button
                                class="v-center border-0 py-1 c-dark dropdown-item"
                                *ngIf="!detail.status"
                                (click)="editTask(detail, true)"
                              >
                                <i class="i-icon i-edit bgc-dark ml-1" aria-hidden="true"></i>
                                <span class="ml-3 f-2 font-weight-bold">Edit</span>
                              </button>
                              <button
                                class="v-center border-0 py-1 c-dark dropdown-item"
                                *ngIf="!detail.status"
                                (click)="completeTask(detail, true)"
                              >
                                <i class="i-icon i-check bgc-dark ml-1" aria-hidden="true"></i>
                                <span class="ml-3 f-2 font-weight-bold">complete</span>
                              </button>
                              <button
                                class="v-center border-0 py-1 c-dark dropdown-item"
                                (click)="archiveTask(detail, true)"
                              >
                                <i class="i-icon i-trash bgc-dark ml-1" aria-hidden="true"></i>
                                <span class="ml-3 f-2 font-weight-bold">Delete</span>
                              </button>
                            </div>
                          </div>
                        </div>
                        <div class="main-history-item" [class.completed]="detail.status">
                          <div class="v-center">
                            <div class="v-center justify-content-center c-pointer task-status" (click)="completeTask(detail, true)"
                              *ngIf="!detail.status; else completedTaskMark">
                              <i class="i-icon i-check bgc-white"></i>
                            </div>
                            <ng-template #completedTaskMark>
                              <div class="v-center justify-content-center task-status">
                                <i class="i-icon i-check bgc-white d-block"></i>
                              </div>
                            </ng-template>
                            <div class="f-6 font-weight-bold ml-3 content">
                              {{detail.content}}
                            </div>
                          </div>
                          <div class="v-center mt-3" *ngIf="detail.status === -1">
                            <div class="time">
                              <div class="f-4 fw-600 op-40">
                                Due date
                              </div>
                              <div class="v-center mt-1">
                                <i class="d-block i-icon i-calendar bgc-dark mr-2"></i>
                                <span class="f-4">{{detail.due_date | date: 'MM/dd/yyyy'}} at {{detail.due_date | date: 'shortTime'}}</span>
                              </div>
                            </div>
                            <div class="type ml-5">
                              <div class="f-4 fw-600 op-40">
                                Type
                              </div>
                              <div class="v-center mt-1">
                                <ng-container [ngSwitch]="detail.type">
                                  <i class="d-block i-icon i-task bgc-dark mr-2" *ngSwitchCase="'task'"></i>
                                  <i class="d-block i-icon i-phone bgc-dark mr-2" *ngSwitchCase="'call'"></i>
                                  <i class="d-block i-icon i-lunch bgc-dark mr-2" *ngSwitchCase="'meeting'"></i>
                                  <i class="d-block i-icon i-message bgc-dark mr-2" *ngSwitchCase="'email'"></i>
                                  <i class="d-block i-icon i-video bgc-dark mr-2" *ngSwitchCase="'material'"></i>
                                </ng-container>
                                <span>{{detail.type}}</span>
                              </div>
                            </div>
                          </div>
                          <div class="related-history-item" *ngIf="groupActions[detail._id] && groupActions[detail._id].length > 1">
                            <app-accordion [showIndicator]="show" [hideIndicator]="hide">
                              <ng-template #show>
                                <div class="">
                                  <div class="f-3 fw-600 c-blue mt-1">
                                    See details
                                  </div>      
                                </div>
                              </ng-template>
                              <ng-template #hide>
                                <div class="w-100">
                                  <ng-container *ngFor="let detailActivity of groupActions[detail._id]; let i = index;">
                                    <div class="d-flex mb-1">
                                      <div class="mr-2 font-weight-bold"># {{groupActions[detail._id].length - i}}</div>
                                      <div class="mr-2 text-capitalize rounded-pill bgc-green-weak text-white px-3">{{detailActivity.content}}</div>
                                      <div class="ml-auto c-trans56">{{detailActivity.created_at | date: 'MMM dd, hh:mm a'}}</div>
                                    </div>
                                  </ng-container>
                                  <div class="f-3 fw-600 c-blue mt-1">
                                    Close
                                  </div>
                                </div>
                              </ng-template>
                            </app-accordion>
                          </div>
                        </div>
                      </div>
                    </ng-container>
                  </ng-container>
                </ng-container>
                <ng-template #emptyDetails>
                  <div class="empty-list">
                    <div class="object-icon v-center">
                      <i class="i-icon i-{{tab.id}} d-block bgc-dark"></i>
                    </div>
                    <h4 class="font-weight-bold mt-4 mb-3">
                      <ng-container *ngIf="tab.id === 'follow_ups'; else anotherEmptyText">
                        <ng-container [ngSwitch]="selectedTimeSort.id">
                          <span *ngSwitchCase="'all'">There are no tasks with this contact yet.</span>
                          <span *ngSwitchCase="'overdue'">There are no overdue tasks.</span>
                          <span *ngSwitchCase="'today'">There are no tasks today.</span>
                          <span *ngSwitchCase="'tomorrow'">There are no tasks tomorrow.</span>
                          <span *ngSwitchCase="'this_week'">There are no tasks for this week.</span>
                          <span *ngSwitchCase="'next_week'">There are no tasks for next week.</span>
                        </ng-container>
                      </ng-container>
                      <ng-template #anotherEmptyText>
                        There are no {{tab.label | lowercase}} with the contacts in this deal yet.
                      </ng-template>
                    </h4>
                  </div>
                </ng-template>
              </ng-template>
              <!-- <ng-container>
                <div *ngIf="(tab.id == 'all' || action.id == 'notes') && activity.type == 'notes'">
                  <div class="history-detail {{activity.type}}-detail p-3 mt-3">
                    <div class="v-center justify-content-between mb-3">
                      <div class="v-center">
                        <div class="history-icon mr-3"><i class="act-icon act-notes"></i></div>
                        <div class="f-6">
                          <span>{{activity.content}}</span>
                        </div>
                      </div>
                      <div class="v-center">
                        <span class="f-3 op-56 ml-auto">{{activity.created_at | date :'MMM d, hh:mm a'}}</span>
                        <div ngbDropdown class="button-more p-1 rounded" placement="bottom-right">
                          <a class="d-flex c-pointer no-carot" ngbDropdownToggle>
                            <i class="i-icon i-menu-more bg-dark" aria-hidden="true"></i>
                          </a>
                          <div ngbDropdownMenu class="light py-1">
                            <button class="v-center border-0 py-1 c-dark dropdown-item" (click)="updateNote(activity)">
                              <i class="i-icon i-edit bgc-dark ml-1" aria-hidden="true"></i>
                              <span class="ml-3 f-2 font-weight-bold">Update note</span>
                            </button>
                            <button class="v-center border-0 py-1 c-dark dropdown-item" (click)="deleteNote(activity)">
                              <i class="i-icon i-trash bgc-dark ml-1" aria-hidden="true"></i>
                              <span class="ml-3 f-2 font-weight-bold">Remove note</span>
                            </button>
                          </div>
                        </div>
                      </div>
                    </div>
                    <ng-container *ngIf="activity.activity_detail; else removedTaskTemplate">
                      <div class="main-history-item">
                        <app-accordion [showIndicator]="show" [hideIndicator]="hide" *ngIf="activity.activity_detail.length && activity.activity_detail[0].content">
                          <ng-template #show>
                            <div class="content f-6 position-relative">
                              <div class="note-content">{{activity.activity_detail[0].content || 'No Content Note' | stripTags | shorten: 300: '...' }}</div>
                              <div class="gradient-bottom"></div>
                              <div class="f-3 fw-600 c-blue mt-1">
                                Expand
                              </div>
                            </div>
                          </ng-template>
                          <ng-template #hide>
                            <div class="content">
                              <div class="f-6 note-content opened">{{activity.activity_detail[0].content}}</div>
                              <div class="f-3 fw-600 c-blue mt-1">
                                Collapse
                              </div>
                            </div>
                          </ng-template>
                        </app-accordion>
                      </div>
                    </ng-container>
                  </div>
                </div>
                <div *ngIf="(action.id == 'all' || action.id == 'emails') && activity.type == 'emails'">
                  <div class="history-detail {{activity.type}}-detail p-3 mt-3">
                    <div class="v-center justify-content-between mb-3">
                      <div class="v-center">
                        <div class="history-icon mr-3"><i class="act-icon act-emails"></i></div>
                        <div class="f-6">
                          <span>{{activity.content}}</span>
                        </div>
                      </div>
                    </div>
                    <ng-container *ngIf="activity.activity_detail">
                      <div class="main-history-item">
                        <ng-container *ngIf="activity.activity_detail.length === 1; else multiEmailHistory">
                          <div class="summary position-relative">
                            <div class="title f-6 font-weight-bold">
                              {{activity.activity_detail[0].subject}}
                            </div>
                            <div class="f-6" [innerHTML]="activity.activity_detail[0]?.content || 'No Content' | stripTags | shorten: 300: '...' "></div>
                            <div class="gradient-bottom"></div>
                            <div class="c-blue mt-1 f-3 fw-600 c-pointer" (click)="showDetail($event)">Expand</div>
                          </div>
                          <div class="detail">
                            <div class="title f-6 font-weight-bold">
                              {{activity.activity_detail[0].subject}}
                            </div>
                            <div class="f-6" [innerHTML]="activity.activity_detail[0]?.content || 'No Content'"></div>
                            <div class="c-blue mt-1 f-3 fw-600 c-pointer" (click)="hideDetail($event)">Collapse</div>
                          </div>
                        </ng-container>
                        <ng-template #multiEmailHistory></ng-template>
                      </div>
                    </ng-container>
                  </div>
                </div>
                <div *ngIf="(action.id == 'all' || action.id == 'follow_ups') && activity.type == 'follow_ups'">
                  <div class="history-detail {{activity.type}}-detail p-3 mt-3">
                    <div class="v-center justify-content-between mb-3">
                      <div class="v-center">
                        <div class="history-icon mr-3"><i class="act-icon act-{{activity.type}} {{activity.activity_detail[0]?.type}}" ></i></div>
                        <div class="f-6">
                          <span>{{activity.content}}</span>
                        </div>
                      </div>
                      <div class="v-center">
                        <span class="f-3 op-56 ml-auto">{{activity.created_at | date :'MMM d, hh:mm a'}}</span>
                        <div ngbDropdown class="button-more p-1 rounded" placement="bottom-right">
                          <a class="d-flex c-pointer no-carot" ngbDropdownToggle>
                            <i class="i-icon i-menu-more bg-dark" aria-hidden="true"></i>
                          </a>
                          <div ngbDropdownMenu class="light py-1">
                            <button
                              class="v-center border-0 py-1 c-dark dropdown-item"
                              *ngIf="activity.content.indexOf('completed') == -1"
                              (click)="editTask(activity)"
                            >
                              <i class="i-icon i-edit bgc-dark ml-1" aria-hidden="true"></i>
                              <span class="ml-3 f-2 font-weight-bold">Edit</span>
                            </button>
                            <button
                              class="v-center border-0 py-1 c-dark dropdown-item"
                              *ngIf="activity.content.indexOf('completed') == -1"
                              (click)="completeTask(activity)"
                            >
                              <i class="i-icon i-check bgc-dark ml-1" aria-hidden="true"></i>
                              <span class="ml-3 f-2 font-weight-bold">Complete</span>
                            </button>
                            <button
                              class="v-center border-0 py-1 c-dark dropdown-item"
                              (click)="archiveTask(activity)"
                            >
                              <i class="i-icon i-trash bgc-dark ml-1" aria-hidden="true"></i>
                              <span class="ml-3 f-2 font-weight-bold">Archive</span>
                            </button>
                          </div>
                        </div>
                      </div>
                    </div>
                    <ng-container *ngIf="activity.activity_detail.length; else removedTaskTemplate">
                      <div class="main-history-item" [class.completed]="activity.content.indexOf('completed') !== -1">
                        <div class="v-center">
                          <div class="v-center justify-content-center c-pointer task-status" (click)="completeTask(activity)"
                               *ngIf="activity.content.indexOf('completed') === -1; else taskComplete">
                            <i class="i-icon i-check bgc-white"></i>
                          </div>
                          <ng-template #taskComplete>
                            <div class="v-center justify-content-center task-status">
                              <i class="i-icon i-check bgc-white"></i>
                            </div>
                          </ng-template>
                          <div class="f-6 font-weight-bold ml-3 content">
                            {{activity.activity_detail[0].content}}
                          </div>
                        </div>
                        <div class="v-center mt-3" *ngIf="activity.content.indexOf('completed') === -1">
                          <div class="time">
                            <div class="f-4 fw-600 op-40">
                              Due date
                            </div>
                            <div class="v-center mt-1">
                              <i class="d-block i-icon i-calendar bgc-dark mr-2"></i>
                              <span class="f-4">{{activity.activity_detail[0].due_date | date: 'MM/dd/yyyy'}} at {{activity.activity_detail[0].due_date | date: 'shortTime'}}</span>
                            </div>
                          </div>
                          <div class="type ml-5">
                            <div class="f-4 fw-600 op-40">
                              Type
                            </div>
                            <div class="v-center mt-1">
                              <ng-container [ngSwitch]="activity.activity_detail[0].type">
                                <i class="d-block i-icon i-task bgc-dark mr-2" *ngSwitchCase="'task'"></i>
                                <i class="d-block i-icon i-phone bgc-dark mr-2" *ngSwitchCase="'call'"></i>
                                <i class="d-block i-icon i-lunch bgc-dark mr-2" *ngSwitchCase="'meeting'"></i>
                                <i class="d-block i-icon i-message bgc-dark mr-2" *ngSwitchCase="'email'"></i>
                                <i class="d-block i-icon i-video bgc-dark mr-2" *ngSwitchCase="'material'"></i>
                              </ng-container>
                              <span class="f-4 text-capitalize">{{activity.activity_detail[0].type}}</span>
                            </div>
                          </div>
                        </div>
                      </div>
                    </ng-container>
                    <ng-template #removedTaskTemplate>
                      <div class="d-flex">
                        <mat-icon class="mr-2">warning</mat-icon>
                        <span>Can't see the detail as it is deleted.</span>
                      </div>
                    </ng-template>
                    <div class="related-history-item" *ngIf="activity.activity_detail.length > 1">
                      <app-accordion [showIndicator]="show" [hideIndicator]="hide">
                        <ng-template #show>
                          <div class="content">
                            <div class="f-3 fw-600 c-blue mt-1">
                              See details
                            </div>
                          </div>
                        </ng-template>
                        <ng-template #hide>
                          <div class="content w-100">
                            <ng-container *ngFor="let detailActivity of activity.activity_detail; let i = index;">
                              <div class="d-flex mb-1">
                                <div class="mr-2 font-weight-bold"># {{activity.activity_detail.length - i}}</div>
                                <div class="mr-2 text-capitalize rounded-pill bgc-green-weak text-white px-3">{{detailActivity.content}}</div>
                                <div class="ml-auto c-trans56">{{detailActivity.created_at | date: 'MMM dd, hh:mm a'}}</div>
                              </div>
                            </ng-container>
                            <div class="f-3 fw-600 c-blue mt-1">
                              Close
                            </div>
                          </div>
                        </ng-template>
                      </app-accordion>
                    </div>
                  </div>
                </div>
                <div *ngIf="(action.id == 'all' || action.id == 'texts') && activity.type == 'texts'">
                </div>
                <div *ngIf="(action.id == 'all' || action.id == 'appointments') && activity.type == 'appointments'">
                </div>
                <div *ngIf="(action.id == 'all' || action.id == 'group_calls') && activity.type == 'group_calls'">
                </div>
              </ng-container> -->
            </div>
          </div>
        </div>
    </div>
</div>
