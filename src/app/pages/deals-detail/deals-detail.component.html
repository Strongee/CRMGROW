<script src="deals-detail.component.ts"></script>
<div class="page-content pt-0">
    <div class="d-flex deal-panel">
        <div class="deal-info-panel pr-3">
            <div class="v-center op-56 c-pointer mb-4 mt-3 back-button" (click)="backPage()">
                <i class="d-block i-icon i-triangle-left bgc-dark mr-2"></i>
                <span class="f-5 font-weight-bold">Back {{getPrevPage()}}</span>
            </div>
            <div class="v-center justify-content-between deal-main mb-3">
                <ng-container *ngIf="titleEditable; else displayTitleTemplate">
                  <div class="form-group mb-0 flex-grow-1 mr-3">
                    <input class="form-control title-input" [(ngModel)]="dealTitle" name="title" #title="ngModel" required (blur)="checkAndSave({keyCode: 13})" (keyup)="checkAndSave($event)" [disabled]="saving" [class.loading]="saving"/>
                  </div>
                </ng-container>
                <ng-template #displayTitleTemplate>
                  <div class="f-6 font-weight-bold mr-3" (click)="focusTitle()">
                    {{deal.main.title}}
                  </div>
                </ng-template>
                <div ngbDropdown class="ml-auto button-more p-0">
                    <div class="v-center btn btn-blue" ngbDropdownToggle>
                      <span class="f-6 font-weight-bold text-white c-pointer px-2">
                        Actions
                      </span>
                      <i class="d-block i-icon more-icon i-triangle-down bgc-white ml-2"></i>
                    </div>
                    <div ngbDropdownMenu class="light action-menu">
                      <button class="v-center border-0 c-dark dropdown-item my-1"
                        [class.disable]="!isPackageAutomation"
                        (click)="openAppointmentDlg()"
                      >
                        <i class="i-icon i-appointments bgc-dark"></i>
                        <span class="ml-2 f-3 font-weight-bold">New Appointment</span>
                      </button>
                      <hr class="my-1">
                      <button class="v-center border-0 c-dark dropdown-item my-1" (click)="openSendEmail()">
                        <i class="i-icon i-message bgc-dark"></i>
                        <span class="ml-2 f-3 font-weight-bold">New Email</span>
                      </button>
                      <button class="v-center border-0 c-dark dropdown-item my-1"
                        (click)="openSendText()"
                        [class.disable]="!isPackageText"
                      >
                        <i class="i-icon i-sms-sent bgc-dark"></i>
                        <span class="ml-2 f-3 font-weight-bold">New Text</span>
                      </button>
                      <button class="v-center border-0 c-dark dropdown-item my-1" (click)="openTaskDlg()">
                        <i class="i-icon i-task bgc-dark"></i>
                        <span class="ml-2 f-3 font-weight-bold">New Task</span>
                      </button>
                      <button class="v-center border-0 c-dark dropdown-item my-1" (click)="openNoteDlg()">
                        <i class="i-icon i-notes bgc-dark"></i>
                        <span class="ml-2 f-3 font-weight-bold">New Note</span>
                      </button>
                      <hr class="my-1">
                      <button class="v-center border-0 dropdown-item my-1" (click)="removeDeal()">
                        <i class="i-icon i-trash bgc-red"></i>
                        <span class="ml-2 f-3 font-weight-bold c-red">Delete</span>
                      </button>
                    </div>
                </div>
            </div>
            <div class="deal-stage mb-3">
                <div class="v-center">
                    <div class="f-6 fw-600 op-40 mr-3">
                        Stage
                    </div>
                    <div ngbDropdown>
                        <div class="v-center c-pointer" ngbDropdownToggle>
                            <span class="f-6 px-2 stage-title">
                                {{selectedStage?.title}}
                            </span>
                            <i class="d-block i-icon i-triangle-down bgc-dark ml-2"></i>
                        </div>
                        <div ngbDropdownMenu class="light">
                            <button class="border-0 c-dark dropdown-item"
                              *ngFor="let stage of stages; let position = index"
                              (click)="moveDeal(stage)"
                            >
                                <span class="ml-1 f-6">{{stage.title}}</span>
                            </button>
                        </div>
                    </div>
                </div>
                <div class="v-center justify-content-between mt-3 stage-status-items" style="height: 6px;" [class.loaded]="selectedStageId">
                    <div class="stage-status stage-{{index}} mr-1" *ngFor="let stage of stages; let index=index" [class.active]="stage._id === selectedStageId">
                    </div>
                </div>
            </div>
            <mat-accordion multi class="general-panels">
              <!-- Begin Additional Field -->
              <ng-container *ngIf="deal.main && !isEmptyObject(deal.main.additional_field)">
                <mat-expansion-panel class="mat-elevation-z" hideToggle [expanded]="true">
                  <mat-expansion-panel-header>
                    <mat-panel-title>
                      <div class="v-center w-100">
                        <i class="i-icon i-triangle-right bgc-dark sm toggle-icon op-40"></i>
                        <span class="f-6 font-weight-bold ml-2">Additional information</span>
                        <button class="btn border-0 border-primary f-2 font-weight-bold c-dark op-28 ml-auto btn-sm v-center" (click)="editAdditional($event)">
                          <i class="i-icon i-edit d-block bgc-dark sm mr-1"></i>
                          <span>Edit</span>
                        </button>
                      </div>
                    </mat-panel-title>
                  </mat-expansion-panel-header>
                  <ng-container *ngFor="let item of deal.main.additional_field | keyvalue">
                    <div class="d-flex py-2">
                      <span class="f-6 fw-600 op-40 info-title">{{item.key}}</span>
                      <span class="f-6">{{item.value}}</span>
                    </div>
                  </ng-container>
                </mat-expansion-panel>
              </ng-container>
              <div class="mt-3">
                <a class="f-3 c-blue font-weight-bold td-none c-pointer" (click)="addAdditionalFields()">
                  New Field
                </a>
              </div>
              <!-- End Additional Field -->

                <!-- Begin Contacts Detail -->
                <mat-expansion-panel class="mat-elevation-z" hideToggle [expanded]="contactsPanel">
                    <mat-expansion-panel-header (click)="contactsPanel = !contactsPanel">
                        <mat-panel-title>
                            <div class="v-center w-100">
                                <i class="i-icon i-triangle-right bgc-dark sm toggle-icon op-40"></i>
                                <span class="f-6 font-weight-bold ml-2">Contacts ({{deal.contacts.length}})</span>
                                <button class="btn border-0 border-primary f-2 font-weight-bold op-28 c-dark ml-auto btn-sm v-center" (click)="addContact()">
                                    <i class="i-icon i-plus d-block bgc-dark sm mr-1"></i>
                                    <span>Add contact</span>
                                </button>
                            </div>
                        </mat-panel-title>
                    </mat-expansion-panel-header>
                    <div class="contact-detail mt-2" *ngFor="let contact of deal.contacts">
                        <div class="contact p-3 position-relative">
                            <div class="v-center pb-2 avatar-wrapper c-pointer" (click)="contactDetail(contact)">
                                <div class="v-center justify-content-center f-6 font-weight-bold text-white avatar">
                                    {{contact.avatarName}}
                                </div>
                                <div class="f-6 font-weight-bold name">
                                    {{contact.fullName}}
                                </div>
                            </div>
                            <div class="v-center mt-2" *ngIf="contact.cell_phone">
                                <i class="d-block i-icon i-contact-phone bgc-dark mx-2"></i>
                                <span class="f-6">{{contact.cell_phone}}</span>
                            </div>
                            <div class="v-center mt-2" *ngIf="contact.email">
                                <i class="d-block i-icon i-message bgc-dark mx-2"></i>
                                <span class="f-6">{{contact.email}}</span>
                            </div>
                            <div ngbDropdown class="contact-more c-pointer" placement="bottom-right">
                              <div class="c-pointer" ngbDropdownToggle>
                                <i class="d-block i-icon i-menu-more bgc-dark"></i>
                              </div>
                              <div ngbDropdownMenu class="light py-1">
                                  <button class="border-0 c-dark dropdown-item f-3 fw-600" (click)="removeContact(contact)">
                                      Remove contact
                                  </button>
                              </div>
                            </div>
                        </div>
                    </div>
                </mat-expansion-panel>
                <!-- End Contacts Detail -->
            </mat-accordion>
        </div>
        <div class="deal-action-panel flex-grow-1 position-relative">
          <div class="history-panel pt-3 pl-3 mt-2">
            <app-slide-tab
              [tabs]="tabs"
              [selected]="tab"
              [disableTabs]="disableTabs"
              (onChange)="changeTab($event)"
              type="plain"
              class="border-bottom pl-0 rounded-0"
            >
            </app-slide-tab>
            <div class="history-list mt-3 position-relative">
              <div class="history-list-header v-center">
                <ng-container *ngIf="tab.id === 'all'">
                  <div ngbDropdown class="v-center">
                    <div class="v-center" ngbDropdownToggle>
                      <span class="f-3 font-weight-bold c-dark c-pointer mr-2">
                        {{activityType.id == 'all' ? 'All activity' : activityType.label}}
                      </span>
                      <i class="d-block i-icon i-triangle-down bgc-dark"></i>
                    </div>
                    <div ngbDropdownMenu class="light">
                      <div class="v-center justify-content-between dropdown-item"
                           *ngFor="let tabItem of tabs" (click)="changeActivityTypes(tabItem)"
                           [class.disable]="isDisableTab(tabItem)"
                      >
                        <div class="f-3 c-dark" [ngClass]="{'font-weight-bold': tabItem.id == activityType.id}" *ngIf="tabItem.id == 'all'; else others">
                          All activity
                        </div>
                        <ng-template #others>
                          <div class="f-3 c-dark" [ngClass]="{'font-weight-bold': tabItem.id == activityType.id}">
                            {{tabItem.label}}
                          </div>
                        </ng-template>
                        <div *ngIf="tabItem.id == activityType.id">
                          <i class="d-block i-icon i-check bgc-blue"></i>
                        </div>
                      </div>
                    </div>
                  </div>
                </ng-container>
                <ng-container *ngIf="tab.id === 'follow_ups'">
                  <div ngbDropdown class="v-center">
                    <div class="v-center" ngbDropdownToggle>
                      <span class="f-3 font-weight-bold c-dark c-pointer mr-2">
                        {{selectedTimeSort.label}}
                      </span>
                      <i class="d-block i-icon i-triangle-down bgc-dark"></i>
                    </div>
                    <div ngbDropdownMenu class="light">
                      <div class="v-center justify-content-between dropdown-item" *ngFor="let timeSort of timeSorts" (click)="changeSort(timeSort)">
                        <div class="f-3 c-dark" [ngClass]="{'font-weight-bold': timeSort.id == selectedTimeSort.id}">
                          {{timeSort.label}}
                        </div>
                        <div *ngIf="timeSort.id == selectedTimeSort.id">
                          <i class="d-block i-icon i-check bgc-blue"></i>
                        </div>
                      </div>
                    </div>
                  </div>
                </ng-container>
                <div class="v-center justify-content-end c-pointer ml-auto" (click)="openNoteDlg()" *ngIf="tab.id === 'notes' || (tab.id !== 'all' && activityType.id === 'notes')">
                  <span class="f-3 font-weight-bold c-blue mr-2">New Note</span>
                </div>
                <div class="v-center justify-content-end c-pointer ml-auto" (click)="openSendEmail()" *ngIf="tab.id === 'emails' || (tab.id === 'all' && activityType.id === 'emails')">
                  <span class="f-3 font-weight-bold c-blue mr-2">New Email</span>
                </div>
                <div class="v-center justify-content-end c-pointer ml-auto" (click)="openSendText()" *ngIf="tab.id === 'texts' || (tab.id === 'all' && activityType.id === 'texts')">
                  <span class="f-3 font-weight-bold c-blue mr-2">New Text</span>
                </div>
                <div class="v-center justify-content-end c-pointer ml-auto"
                  (click)="openAppointmentDlg()"
                  *ngIf="tab.id === 'appointments' || (tab.id === 'all' && activityType.id === 'appointments')"
                  [class.disable]="!isPackageAutomation"
                >
                  <span class="f-3 font-weight-bold c-blue mr-2">New Appointment</span>
                </div>
                <!-- <div class="v-center justify-content-end c-pointer ml-auto" (click)="openGroupCallDlg()" *ngIf="tab.id === 'team_calls' || (tab.id === 'all' && activityType.id === 'team_calls')">
                  <span class="f-3 font-weight-bold c-blue mr-2">Create group call</span>
                  <i class="d-block i-icon i-plus bgc-blue"></i>
                </div> -->
                <div class="v-center justify-content-end c-pointer ml-auto" (click)="openTaskDlg()" *ngIf="tab.id === 'follow_ups' || (tab.id === 'all' && activityType.id === 'follow_ups')">
                  <span class="f-3 font-weight-bold c-blue mr-2">New Task</span>
                </div>
              </div>
              <ng-container *ngIf="tab.id === 'all'; else detailsTemplate">
                <ng-container *ngFor="let activity of mainTimelines; let i = index;">

                  <div *ngIf="activityType.id == 'all' && activity.type == 'contacts'">
                    <div class="history-detail {{activity.type}}-detail p-3 mt-3">
                      <div class="v-center justify-content-between">
                        <div class="v-center">
                          <div class="history-icon mr-3"><i class="act-icon act-{{activity.type}}" ></i></div>
                          <div class="f-6">
                            <span>{{activity.content}}</span>
                          </div>
                        </div>
                        <div class="f-3 op-56 ml-auto mr-span">
                          {{activity.created_at | date :'MMM d, hh:mm a'}}
                        </div>
                      </div>
                    </div>
                  </div>

                  <div *ngIf="(activityType.id == 'all' || activityType.id == 'follow_ups') && activity.type == 'follow_ups'">
                    <div class="history-detail {{activity.type}}-detail p-3 mt-3">
                      <div class="v-center justify-content-between mb-3">
                        <div class="v-center">
                          <div class="history-icon mr-3"><i class="act-icon act-follow_ups" ></i></div>
                          <div class="f-6">
                            <span>{{activity.content}}</span>
                          </div>
                        </div>
                        <div class="v-center">
                          <span class="f-3 op-56 ml-auto">{{activity.created_at | date :'MMM d, hh:mm a'}}</span>
                          <div ngbDropdown class="button-more p-1 rounded" placement="bottom-right">
                            <a class="d-flex c-pointer no-carot" ngbDropdownToggle>
                              <i class="i-icon i-menu-more bg-dark" aria-hidden="true"></i>
                            </a>
                            <div ngbDropdownMenu class="light py-1">
                              <ng-container *ngIf="dataObj.tasks[activity.follow_ups]; else removedTaskAction">
                                <button
                                  class="v-center border-0 py-1 c-dark dropdown-item"
                                  *ngIf="!dataObj.tasks[activity.follow_ups].status"
                                  (click)="editTask(dataObj.tasks[activity.follow_ups])"
                                >
                                  <i class="i-icon i-edit bgc-dark ml-1" aria-hidden="true"></i>
                                  <span class="ml-3 f-2 font-weight-bold">Edit</span>
                                </button>
                                <button
                                  class="v-center border-0 py-1 c-dark dropdown-item"
                                  *ngIf="!dataObj.tasks[activity.follow_ups].status"
                                  (click)="completeTask(dataObj.tasks[activity.follow_ups])"
                                >
                                  <i class="i-icon i-check bgc-dark ml-1" aria-hidden="true"></i>
                                  <span class="ml-3 f-2 font-weight-bold">Complete</span>
                                </button>
                                <button
                                  class="v-center border-0 py-1 c-dark dropdown-item"
                                  (click)="archiveTask(dataObj.tasks[activity.follow_ups])"
                                >
                                  <i class="i-icon i-trash bgc-dark ml-1" aria-hidden="true"></i>
                                  <span class="ml-3 f-2 font-weight-bold">Delete</span>
                                </button>
                              </ng-container>
                              <ng-template #removedTaskAction>
                                <button
                                  class="v-center border-0 py-1 c-dark dropdown-item"
                                  (click)="removeActivity(activity)"
                                >
                                  <i class="i-icon i-edit bgc-dark ml-1" aria-hidden="true"></i>
                                  <span class="ml-3 f-2 font-weight-bold">Delete</span>
                                </button>
                              </ng-template>
                            </div>
                          </div>
                        </div>
                      </div>
                      <ng-container *ngIf="dataObj.tasks[activity.follow_ups]; else removedTaskTemplate">
                        <div class="main-history-item" [class.completed]="activity.content.indexOf('completed') !== -1">
                          <div class="v-center">
                            <div class="v-center justify-content-center c-pointer task-status" (click)="completeTask(dataObj.tasks[activity.follow_ups])"
                              *ngIf="activity.content.indexOf('completed') === -1; else taskComplete">
                              <i class="i-icon i-check bgc-white"></i>
                            </div>
                            <ng-template #taskComplete>
                              <div class="v-center justify-content-center task-status">
                                <i class="i-icon i-check bgc-white"></i>
                              </div>
                            </ng-template>
                            <div class="f-6 font-weight-bold ml-3 content">
                              {{dataObj.tasks[activity.follow_ups].content}}
                            </div>
                          </div>
                          <div class="v-center mt-3" *ngIf="activity.content.indexOf('completed') === -1">
                            <div class="time">
                              <div class="f-4 fw-600 op-40">
                                Due date
                              </div>
                              <div class="v-center mt-1">
                                <i class="d-block i-icon i-calendar bgc-dark mr-2"></i>
                                <span class="f-4">{{dataObj.tasks[activity.follow_ups].due_date | timezone: timezone:'MM/D/YYYY'}} at {{dataObj.tasks[activity.follow_ups].due_date | timezone: timezone: 'hh:mm A'}}</span>
                              </div>
                            </div>
                            <div class="type ml-5">
                              <div class="f-4 fw-600 op-40">
                                Type
                              </div>
                              <div class="v-center mt-1">
                                <ng-container [ngSwitch]="dataObj.tasks[activity.follow_ups].type">
                                  <i class="d-block i-icon i-task bgc-dark mr-2" *ngSwitchCase="'task'"></i>
                                  <i class="d-block i-icon i-phone bgc-dark mr-2" *ngSwitchCase="'call'"></i>
                                  <i class="d-block i-icon i-lunch bgc-dark mr-2" *ngSwitchCase="'meeting'"></i>
                                  <i class="d-block i-icon i-message bgc-dark mr-2" *ngSwitchCase="'email'"></i>
                                  <i class="d-block i-icon i-video bgc-dark mr-2" *ngSwitchCase="'material'"></i>
                                </ng-container>
                                <span class="f-4 text-capitalize">{{dataObj.tasks[activity.follow_ups].type}}</span>
                              </div>
                            </div>
                          </div>
                        </div>
                      </ng-container>
                      <ng-template #removedTaskTemplate>
                        <div class="d-flex">
                          <mat-icon class="mr-2">warning</mat-icon>
                          <span>Can't see the detail as it is deleted.</span>
                        </div>
                      </ng-template>
                      <div class="related-history-item" *ngIf="groupActions[activity.group_id].length > 1">
                        <app-accordion [showIndicator]="show" [hideIndicator]="hide">
                          <ng-template #show>
                            <div class="content">
                              <div class="f-3 fw-600 c-blue mt-1">
                                See details
                              </div>
                            </div>
                          </ng-template>
                          <ng-template #hide>
                            <div class="content w-100">
                              <ng-container *ngFor="let detailActivity of groupActions[activity.group_id]; let i = index;">
                                <div class="d-flex mb-1">
                                  <div class="mr-2 font-weight-bold"># {{groupActions[activity.group_id].length - i}}</div>
                                  <div class="mr-2 text-capitalize rounded-pill bgc-green-weak text-white px-3">{{detailActivity.content}}</div>
                                  <div class="ml-auto c-trans56">{{detailActivity.created_at | date: 'MMM dd, hh:mm a'}}</div>
                                </div>
                              </ng-container>
                              <div class="f-3 fw-600 c-blue mt-1">
                                Close
                              </div>
                            </div>
                          </ng-template>
                        </app-accordion>
                      </div>
                    </div>
                  </div>

                  <div *ngIf="(activityType.id == 'all' || activityType.id == 'notes') && activity.type == 'notes'">
                    <div class="history-detail {{activity.type}}-detail p-3 mt-3">
                      <div class="v-center justify-content-between mb-3">
                        <div class="v-center">
                          <div class="history-icon mr-3"><i class="act-icon act-notes" ></i></div>
                          <div class="f-6">
                            <span>{{activity.content}}</span>
                          </div>
                        </div>
                        <div class="v-center">
                          <span class="f-3 op-56 ml-auto">{{activity.created_at | date :'MMM d, hh:mm a'}}</span>
                          <div ngbDropdown class="button-more p-1 rounded" placement="bottom-right">
                            <a class="d-flex c-pointer no-carot" ngbDropdownToggle>
                              <i class="i-icon i-menu-more bg-dark" aria-hidden="true"></i>
                            </a>
                            <div ngbDropdownMenu class="light py-1">
                              <ng-container *ngIf="dataObj.notes[activity.notes]; else removedNoteAction">
                                <button class="v-center border-0 py-1 c-dark dropdown-item" (click)="updateNoteDetail(dataObj.notes[activity.notes])">
                                  <i class="i-icon i-edit bgc-dark ml-1" aria-hidden="true"></i>
                                  <span class="ml-3 f-2 font-weight-bold">Edit</span>
                                </button>
                                <button class="v-center border-0 py-1 c-dark dropdown-item" (click)="deleteNoteDetail(dataObj.notes[activity.notes])">
                                  <i class="i-icon i-trash bgc-dark ml-1" aria-hidden="true"></i>
                                  <span class="ml-3 f-2 font-weight-bold">Delete</span>
                                </button>
                              </ng-container>
                              <ng-template #removedNoteAction>
                                <button class="v-center border-0 py-1 c-dark dropdown-item" (click)="removeActivity(activity)">
                                  <i class="i-icon i-trash bgc-dark ml-1" aria-hidden="true"></i>
                                  <span class="ml-3 f-2 font-weight-bold">Delete</span>
                                </button>
                              </ng-template>
                            </div>
                          </div>
                        </div>
                      </div>
                      <ng-container *ngIf="dataObj.notes[activity.notes]; else removedNoteTemplate">
                        <div class="main-history-item">
                          <div class="summary">
                            <div class="note-content">{{dataObj.notes[activity.notes].content || 'No Content Note' | stripTags | shorten: 300: '...' }}</div>
                            <div class="gradient-bottom note-gradient"></div>
                            <div class="c-blue mt-1 f-3 fw-600 c-pointer" (click)="showDetail($event)">Expand</div>
                          </div>
                          <div class="detail">
                            <div class="f-6 note-content opened" [innerHTML]="dataObj.notes[activity.notes].content"></div>
                            <div class="c-blue mt-2 f-3 fw-600 c-pointer" (click)="hideDetail($event)">Collapse</div>
                          </div>
                        </div>
                      </ng-container>
                      <ng-template #removedNoteTemplate>
                        <div class="d-flex">
                          <mat-icon class="mr-2">warning</mat-icon>
                          <span>Can't see the detail as it is deleted.</span>
                        </div>
                      </ng-template>
                    </div>
                  </div>

                  <div *ngIf="(activityType.id == 'all' || activityType.id == 'emails') && (groups[i].type == 'emails')">
                    <div class="history-detail {{activity.type}}-detail p-3 mt-3">
                      <div class="v-center justify-content-between mb-3">
                        <div class="v-center">
                          <div class="history-icon mr-3"><i class="act-icon act-{{activity.type}} {{activity[activity.type]?.type}}" ></i></div>
                          <div class="f-6">
                            <span>{{activity.content}}</span>
                          </div>
                        </div>
                        <div class="v-center ml-auto mr-span">
                          <span class="f-3 op-56">{{activity.created_at | date :'MMM d, hh:mm a'}}</span>
                        </div>
                      </div>

                      <ng-container *ngIf="groups[i].type === 'emails'">
                        <app-email-timelines
                          [email]="dataObj.emails[groups[i].group]"
                          [timelines]="groupActions[groups[i].group]"
                          [expanded]="dGroups.indexOf(groups[i].group) !== -1"
                          [materials]="dataObj.materials"
                          (onExpand)="showMoreDetail(groups[i].group)"
                          (onCollapse)="hideMoreDetail(groups[i].group)"
                          [showContact]="true"
                          [contacts]="deal?.contacts || []"
                        >
                        </app-email-timelines>
                      </ng-container>
                    </div>

                  </div>

                  <div *ngIf="(activityType.id == 'all' || activityType.id == 'texts') && (groups[i].type == 'texts' || groups[i].media == 'texts')"
                    [class.disable]="!isPackageText"
                  >
                    <div class="history-detail {{activity.type}}-detail p-3 mt-3">
                      <div class="v-center justify-content-between mb-3">
                        <div class="v-center">
                          <div class="history-icon mr-3"><i class="act-icon act-{{activity.type}} {{activity[activity.type]?.type}}" ></i></div>
                          <div class="f-6">
                            <span>{{activity.content}}</span>
                          </div>
                        </div>
                        <div class="v-center ml-auto mr-span">
                          <span class="f-3 op-56">{{activity.created_at | date :'MMM d, hh:mm a'}}</span>
                        </div>
                      </div>

                      <ng-container *ngIf="groups[i].type === 'texts'">
                        <app-text-timelines
                          [text]="dataObj.texts[groups[i].group]"
                          [timelines]="groupActions[groups[i].group]"
                          [expanded]="dGroups.indexOf(groups[i].group) !== -1"
                          [materials]="dataObj.materials"
                          (onExpand)="showMoreDetail(groups[i].group)"
                          (onCollapse)="hideMoreDetail(groups[i].group)"
                          [showContact]="true"
                          [contacts]="deal?.contacts || []"
                        >
                        </app-text-timelines>
                      </ng-container>
                    </div>
                  </div>

                  <div *ngIf="(activityType.id == 'all' || activityType.id == 'appointments') && activity.type == 'appointments'"
                       [class.disable]="!isPackageAutomation"
                  >
                    <div class="history-detail {{activity.type}}-detail p-3 mt-3">
                      <div class="v-center justify-content-between mb-3">
                        <div class="v-center">
                          <div class="history-icon mr-3"><i class="act-icon act-appointments" ></i></div>
                          <div class="f-6">
                            <span>{{activity.content}}</span>
                          </div>
                        </div>
                        <div class="v-center">
                          <span class="f-3 op-56 ml-auto">{{activity.created_at | date :'MMM d, hh:mm a'}}</span>
                          <div ngbDropdown class="button-more p-1 rounded" placement="bottom-right">
                            <a class="d-flex c-pointer no-carot" ngbDropdownToggle>
                              <i class="i-icon i-menu-more bg-dark" aria-hidden="true"></i>
                            </a>
                            <div ngbDropdownMenu class="light py-1">
                              <button class="v-center border-0 py-1 c-dark dropdown-item" (click)="removeActivity(activity)">
                                <i class="i-icon i-trash bgc-dark ml-1" aria-hidden="true"></i>
                                <span class="ml-3 f-2 font-weight-bold">Delete activity</span>
                              </button>
                            </div>
                          </div>
                        </div>
                      </div>
                      <ng-container *ngIf="dataObj.appointments[activity.appointments]; else removedAppointmentTemplate">
                        <a class="font-weight-bold c-pointer ci-dark td-none appt-title" (click)="openDetailEvent(dataObj.appointments[activity.appointments], $event)">
                          {{dataObj.appointments[activity.appointments].title}}
                        </a>
                        <div class="main-history-item">
                          <div class="summary position-relative">
                            <div class="f-6" [innerHTML]="dataObj.appointments[activity.appointments].description || '' | stripTags | shorten: 300: '...' | makeRedirect"></div>
                            <div class="gradient-bottom"></div>
                            <div class="f-3 fw-600 c-blue mt-1 c-pointer" (click)="showDetail($event)">
                              Expand
                            </div>
                          </div>
                          <div class="detail">
                            <div class="f-6" [innerHTML]="dataObj.appointments[activity.appointments].description || '' | makeRedirect"></div>
                            <div class="f-3 fw-600 c-blue mt-1 c-pointer" (click)="hideDetail($event)">
                              Collapse
                            </div>
                          </div>
                          <div class="v-center mt-3">
                            <div class="date">
                              <div class="f-4 fw-600 op-40">
                                Date
                              </div>
                              <div class="v-center mt-1">
                                <i class="d-block i-icon i-calendar bgc-dark mr-2"></i>
                                <span class="f-4">{{dataObj.appointments[activity.appointments].due_start | date: 'MM/dd/yyyy'}}</span>
                              </div>
                            </div>
                            <div class="time ml-5">
                              <div class="f-4 fw-600 op-40">
                                Time
                              </div>
                              <div class="v-center mt-1">
                                <i class="d-block i-icon i-timer bgc-dark mr-2"></i>
                                <span class="f-4">{{getTime(dataObj.appointments[activity.appointments].due_start, dataObj.appointments[activity.appointments].due_end)}}</span>
                              </div>
                            </div>
                            <div class="location ml-5">
                              <div class="f-4 fw-600 op-40">
                                Location
                              </div>
                              <div class="v-center mt-1">
                                <i class="d-block i-icon i-location bgc-dark mr-2"></i>
                                <span class="f-4">{{dataObj.appointments[activity.appointments].location}}</span>
                              </div>
                            </div>
                          </div>
                          <div class="mt-4" *ngIf="dataObj.appointments[activity.appointments].zoom_link">
                            <div class="f-4 fw-600 op-40">
                              Zoom meeting
                            </div>
                            <div class="f-4 c-blue mt-1">
                              {{dataObj.appointments[activity.appointments].zoom_link}}
                            </div>
                          </div>
                        </div>
                      </ng-container>
                      <ng-template #removedAppointmentTemplate>
                        <div class="d-flex">
                          <mat-icon class="mr-2">warning</mat-icon>
                          <span>Can't see the detail as it is deleted.</span>
                        </div>
                      </ng-template>
                    </div>
                  </div>

                  <div *ngIf="(activityType.id == 'all') && activity.type == 'users'">
                    <div class="history-detail {{activity.type}}-detail p-3 mt-3">
                      <div class="v-center justify-content-between mb-3">
                        <div class="v-center">
                          <div class="history-icon mr-3"><i class="act-icon act-{{activity.type}} {{activity.activity_detail?.type}}" ></i></div>
                          <div class="f-6">
                            <span>{{activity.content}}</span>
                          </div>
                        </div>
                        <div class="v-center">
                          <span class="f-3 op-56 ml-auto mr-span">{{activity.created_at | date :'MMM d, hh:mm a'}}</span>
                        </div>
                      </div>
                      <ng-container *ngIf="activity.activity_detail; else canceledUserTemplate">
                        <div class="main-history-item">
                          <label class="mb-0 op-75 f-3 mt-">Shared With</label>
                          <div class="v-center mt-2">
                            <img *ngIf="activity.activity_detail.picture_profile; else avatarNameTemplate" [src]="activity.activity_detail.picture_profile" onerror="( this.src = './assets/img/user_avatar.svg');" class="form-avatar rounded-circle mr-1" />
                            <ng-template #avatarNameTemplate>
                              <div class="form-avatar rounded-circle bg-dark mr-1">{{activity.activity_detail.user_name[0]}}</div>
                            </ng-template>
                            <div class="ml-2 font-weight-bold">{{activity.activity_detail.user_name}}</div>
                          </div>
                        </div>
                      </ng-container>
                      <ng-template #canceledUserTemplate>

                      </ng-template>
                    </div>
                  </div>
                </ng-container>

                <ng-container *ngIf="activityType.id !== 'all' && !activityCounts[activityType.id]">
                  <div class="empty-list">
                    <div class="object-icon v-center">
                      <i class="i-icon i-{{activityType.id}} d-block bgc-dark"></i>
                    </div>
                    <h4 class="font-weight-bold mt-4 mb-3">
                      There are no {{activityType.label | lowercase}} with this contact yet.
                    </h4>
                  </div>
                </ng-container>

                <div class="history-detail p-3 mt-3" *ngIf="activityType.id === 'all'">
                  <div class="v-center justify-content-between mb-3">
                    <div class="v-center">
                      <div class="history-icon mr-3"><i class="act-icon act-deals"></i></div>
                      <div class="f-6">
                        <span>Deal created</span>
                      </div>
                    </div>
                    <div class="v-center ml-auto">
                      <span class="f-3 op-56 ml-auto">{{deal.main.created_at | date: 'MMM dd, hh:mm a'}}</span>
                    </div>
                  </div>
                  <div class="f-3 font-weight-bold ml-4 pl-2">
                    This deal was created
                  </div>
                </div>
              </ng-container>

              <ng-template #detailsTemplate>
                <ng-container *ngIf="showingDetails.length; else emptyDetails">
                  <ng-container *ngFor="let detail of showingDetails">
                    <ng-container [ngSwitch]="tab.id">
                      <div class="history-detail notes-detail p-3 mt-3" *ngSwitchCase="'notes'">
                        <div class="v-center justify-content-between mb-3">
                          <div class="history-icon mr-3"><i class="act-icon act-notes"></i></div>
                          <div class="">note</div>
                          <div class="ml-auto f-3 op-56">
                            {{detail.created_at | date :'MMM d, hh:mm a'}}
                          </div>
                          <div ngbDropdown class="button-more p-1 rounded" placement="bottom-right">
                            <a class="d-flex c-pointer no-carot" ngbDropdownToggle>
                              <i class="i-icon i-menu-more bg-dark" aria-hidden="true"></i>
                            </a>
                            <div ngbDropdownMenu class="light py-1">
                              <button
                                class="v-center border-0 py-1 c-dark dropdown-item"
                                (click)="updateNoteDetail(detail)"
                              >
                                <i class="i-icon i-edit bgc-dark ml-1" aria-hidden="true"></i>
                                <span class="ml-3 f-2 font-weight-bold">Edit</span>
                              </button>
                              <button
                                class="v-center border-0 py-1 c-dark dropdown-item"
                                (click)="deleteNoteDetail(detail)"
                              >
                                <i class="i-icon i-trash bgc-dark ml-1" aria-hidden="true"></i>
                                <span class="ml-3 f-2 font-weight-bold">Delete</span>
                              </button>
                            </div>
                          </div>
                        </div>
                        <div class="main-history-item">
                          <app-accordion [showIndicator]="show" [hideIndicator]="hide">
                            <ng-template #show>
                              <div class="content f-6 position-relative">
                                <div class="note-content">{{detail.content || '' | stripTags | shorten: 300: '...' }}</div>
                                <div class="gradient-bottom"></div>
                                <div class="f-3 fw-600 c-blue mt-1">
                                  Expand
                                </div>
                              </div>
                            </ng-template>
                            <ng-template #hide>
                              <div class="content">
                                <div class="f-6 note-content opened" [innerHTML]="detail.content"></div>
                                <div class="f-3 fw-600 c-blue mt-1">
                                  Collapse
                                </div>
                              </div>
                            </ng-template>
                          </app-accordion>
                        </div>
                      </div>
                      <div class="history-detail emails-detail p-3 mt-3" *ngSwitchCase="'emails'">
                        <div class="v-center justify-content-between mb-3">
                          <div class="history-icon mr-3"><i class="act-icon act-{{detail.data_type}}"></i></div>
                          <div class="">
                            <ng-container [ngSwitch]="detail.data_type">
                              <span *ngSwitchCase="'emails'">email</span>
                              <span *ngSwitchCase="'videos'">video</span>
                              <span *ngSwitchCase="'pdfs'">pdf</span>
                              <span *ngSwitchCase="'images'">image</span>
                            </ng-container>
                          </div>
                          <div class="ml-auto f-3 op-56 mr-span">
                            {{detail.updated_at | date :'MMM d, hh:mm a'}}
                          </div>
                        </div>

                        <ng-container *ngIf="detail.data_type ==='emails'">
                          <app-email-timelines
                            [email]="detail"
                            [timelines]="groupActions[detail._id]"
                            [expanded]="dGroups.indexOf(detail._id) !== -1"
                            [materials]="dataObj.materials"
                            (onExpand)="showMoreDetail(detail._id)"
                            (onCollapse)="hideMoreDetail(detail._id)"
                            [showContact]="true"
                            [contacts]="deal?.contacts || []"
                          >
                          </app-email-timelines>
                        </ng-container>
                      </div>

                      <div class="history-detail texts-detail p-3 mt-3"
                           *ngSwitchCase="'texts'"
                           [class.disable]="!isPackageText"
                      >
                        <div class="v-center justify-content-between mb-3">
                          <div class="history-icon mr-3"><i class="act-icon act-{{detail.data_type}}"></i></div>
                          <div class="">
                            <ng-container [ngSwitch]="detail.data_type">
                              <span *ngSwitchCase="'texts'">text</span>
                              <span *ngSwitchCase="'videos'">video</span>
                              <span *ngSwitchCase="'pdfs'">pdf</span>
                              <span *ngSwitchCase="'images'">image</span>
                            </ng-container>
                          </div>
                          <div class="ml-auto f-3 op-56 mr-span">
                            {{detail.updated_at | date :'MMM d, hh:mm a'}}
                          </div>
                        </div>

                        <ng-container *ngIf="detail.data_type ==='texts'">
                          <div class="text-direction mb-3">
                            <ng-container *ngIf="detail['sent']; else receivedDir">
                              <h6 class="font-weight-bold mb-0">{{(userService.profile$ | async).user_name}}</h6>
                              <div class="op-75 f-3">to {{deal.contacts[0].fullName}}</div>
                            </ng-container>
                            <ng-template #receivedDir>
                              <h6 class="font-weight-bold mb-0">{{deal.contacts[0].fullName}}</h6>
                              <div class="op-75 f-3">to {{(userService.profile$ | async).user_name}}</div>
                            </ng-template>
                          </div>
                          <app-text-timelines
                            [text]="detail"
                            [timelines]="groupActions[detail._id]"
                            [expanded]="dGroups.indexOf(detail._id) !== -1"
                            [materials]="dataObj.materials"
                            (onExpand)="showMoreDetail(detail._id)"
                            (onCollapse)="hideMoreDetail(detail._id)"
                            [showContact]="true"
                            [contacts]="deal?.contacts || []"
                          >
                          </app-text-timelines>
                        </ng-container>
                      </div>

                      <div class="history-detail appointments-detail p-3 mt-3"
                           [class.disable]="!isPackageAutomation"
                           *ngSwitchCase="'appointments'"
                      >
                        <div class="v-center justify-content-between mb-3">
                          <div class="history-icon mr-3"><i class="act-icon act-appointments"></i></div>
                          <div class="">appointment</div>
                          <div class="ml-auto f-3 op-56 mr-span">
                            {{detail.created_at | date :'MMM d, hh:mm a'}}
                          </div>
                        </div>
                        <div class="main-history-item">
                          <div class="summary">
                            <div class="content f-6 position-relative">
                              <a class="font-weight-bold c-pointer ci-dark td-none appt-title" (click)="openDetailEvent(detail, $event)">
                                {{detail.title}}
                              </a>
                              <div class="f-6" [innerHTML]="detail.description || '' | stripTags | shorten: 300: '...' | makeRedirect"></div>
                              <div class="gradient-bottom"></div>
                              <div class="f-3 fw-600 c-blue mt-1 c-pointer" (click)="showDetail($event)">
                                Expand
                              </div>
                            </div>
                          </div>
                          <div class="detail">
                            <div class="content">
                              <a class="f-6 font-weight-bold c-pointer ci-dark td-none appt-title" (click)="openDetailEvent(detail, $event)">
                                {{detail.title}}
                              </a>
                              <div class="f-6" [innerHTML]="detail.description || '' | makeRedirect"></div>
                              <div class="f-3 fw-600 c-blue mt-1 c-pointer" (click)="hideDetail($event)">
                                Collapse
                              </div>
                            </div>
                          </div>
                          <div class="v-center mt-3">
                            <div class="date">
                              <div class="f-4 fw-600 op-40">
                                Date
                              </div>
                              <div class="v-center mt-1">
                                <i class="d-block i-icon i-calendar bgc-dark mr-2"></i>
                                <span class="f-4">{{detail.due_start | date: 'MM/dd/yyyy'}}</span>
                              </div>
                            </div>
                            <div class="time ml-5">
                              <div class="f-4 fw-600 op-40">
                                Time
                              </div>
                              <div class="v-center mt-1">
                                <i class="d-block i-icon i-timer bgc-dark mr-2"></i>
                                <span class="f-4">{{getTime(detail.due_start,detail.due_end)}}</span>
                              </div>
                            </div>
                            <div class="location ml-5">
                              <div class="f-4 fw-600 op-40">
                                Location
                              </div>
                              <div class="v-center mt-1">
                                <i class="d-block i-icon i-location bgc-dark mr-2"></i>
                                <span class="f-4">{{detail.location}}</span>
                              </div>
                            </div>
                          </div>
                          <div class="mt-4" *ngIf="detail.zoom_link">
                            <div class="f-4 fw-600 op-40">
                              Zoom meeting
                            </div>
                            <div class="f-4 c-blue mt-1">
                              {{detail.zoom_link}}
                            </div>
                          </div>
                        </div>
                      </div>

                      <div class="history-detail follow_ups-detail p-3 mt-3" *ngSwitchCase="'follow_ups'">
                        <div class="v-center justify-content-between mb-3">
                          <div class="history-icon mr-3"><i class="act-icon act-follow_ups"></i></div>
                          <div class="">task</div>
                          <div class="ml-auto f-3 op-56">
                            {{detail.created_at | date :'MMM d, hh:mm a'}}
                          </div>
                          <div ngbDropdown class="button-more p-1 rounded" placement="bottom-right">
                            <a class="d-flex c-pointer no-carot" ngbDropdownToggle>
                              <i class="i-icon i-menu-more bg-dark" aria-hidden="true"></i>
                            </a>
                            <div ngbDropdownMenu class="light py-1">
                              <button
                                class="v-center border-0 py-1 c-dark dropdown-item"
                                *ngIf="!detail.status"
                                (click)="editTask(detail)"
                              >
                                <i class="i-icon i-edit bgc-dark ml-1" aria-hidden="true"></i>
                                <span class="ml-3 f-2 font-weight-bold">Edit</span>
                              </button>
                              <button
                                class="v-center border-0 py-1 c-dark dropdown-item"
                                *ngIf="!detail.status"
                                (click)="completeTask(detail)"
                              >
                                <i class="i-icon i-check bgc-dark ml-1" aria-hidden="true"></i>
                                <span class="ml-3 f-2 font-weight-bold">complete</span>
                              </button>
                              <button
                                class="v-center border-0 py-1 c-dark dropdown-item"
                                (click)="archiveTask(detail)"
                              >
                                <i class="i-icon i-trash bgc-dark ml-1" aria-hidden="true"></i>
                                <span class="ml-3 f-2 font-weight-bold">Delete</span>
                              </button>
                            </div>
                          </div>
                        </div>
                        <div class="main-history-item" [class.completed]="detail.status">
                          <div class="v-center">
                            <div class="v-center justify-content-center c-pointer task-status" (click)="completeTask(detail)"
                              *ngIf="!detail.status; else completedTaskMark">
                              <i class="i-icon i-check bgc-white"></i>
                            </div>
                            <ng-template #completedTaskMark>
                              <div class="v-center justify-content-center task-status">
                                <i class="i-icon i-check bgc-white d-block"></i>
                              </div>
                            </ng-template>
                            <div class="f-6 font-weight-bold ml-3 content">
                              {{detail.content}}
                            </div>
                          </div>
                          <div class="v-center mt-3">
                            <div class="time">
                              <div class="f-4 fw-600 op-40">
                                Due date
                              </div>
                              <div class="v-center mt-1">
                                <i class="d-block i-icon i-calendar bgc-dark mr-2"></i>
                                <span class="f-4">{{detail.due_date | timezone: timezone:'MM/D/YYYY'}} at {{detail.due_date | timezone: timezone: 'hh:mm A'}}</span>
                              </div>
                            </div>
                            <div class="type ml-5">
                              <div class="f-4 fw-600 op-40">
                                Type
                              </div>
                              <div class="v-center mt-1">
                                <ng-container [ngSwitch]="detail.type">
                                  <i class="d-block i-icon i-task bgc-dark mr-2" *ngSwitchCase="'task'"></i>
                                  <i class="d-block i-icon i-phone bgc-dark mr-2" *ngSwitchCase="'call'"></i>
                                  <i class="d-block i-icon i-lunch bgc-dark mr-2" *ngSwitchCase="'meeting'"></i>
                                  <i class="d-block i-icon i-message bgc-dark mr-2" *ngSwitchCase="'email'"></i>
                                  <i class="d-block i-icon i-video bgc-dark mr-2" *ngSwitchCase="'material'"></i>
                                </ng-container>
                                <span>{{detail.type}}</span>
                              </div>
                            </div>
                          </div>
                          <div class="related-history-item" *ngIf="groupActions[detail._id] && groupActions[detail._id].length > 1">
                            <app-accordion [showIndicator]="show" [hideIndicator]="hide">
                              <ng-template #show>
                                <div class="">
                                  <div class="f-3 fw-600 c-blue mt-1">
                                    See details
                                  </div>
                                </div>
                              </ng-template>
                              <ng-template #hide>
                                <div class="w-100">
                                  <ng-container *ngFor="let detailActivity of groupActions[detail._id]; let i = index;">
                                    <div class="d-flex mb-1">
                                      <div class="mr-2 font-weight-bold"># {{groupActions[detail._id].length - i}}</div>
                                      <div class="mr-2 text-capitalize rounded-pill bgc-green-weak text-white px-3">{{detailActivity.content}}</div>
                                      <div class="ml-auto c-trans56">{{detailActivity.created_at | date: 'MMM dd, hh:mm a'}}</div>
                                    </div>
                                  </ng-container>
                                  <div class="f-3 fw-600 c-blue mt-1">
                                    Close
                                  </div>
                                </div>
                              </ng-template>
                            </app-accordion>
                          </div>
                        </div>
                      </div>
                    </ng-container>
                  </ng-container>
                </ng-container>

                <ng-template #emptyDetails>
                  <div class="empty-list">
                    <div class="object-icon v-center">
                      <i class="i-icon i-{{tab.id}} d-block bgc-dark"></i>
                    </div>
                    <h4 class="font-weight-bold mt-4 mb-3">
                      <ng-container *ngIf="tab.id === 'follow_ups'; else anotherEmptyText">
                        <ng-container [ngSwitch]="selectedTimeSort.id">
                          <span *ngSwitchCase="'all'">There are no tasks with this contact yet.</span>
                          <span *ngSwitchCase="'overdue'">There are no overdue tasks.</span>
                          <span *ngSwitchCase="'today'">There are no tasks today.</span>
                          <span *ngSwitchCase="'tomorrow'">There are no tasks tomorrow.</span>
                          <span *ngSwitchCase="'this_week'">There are no tasks for this week.</span>
                          <span *ngSwitchCase="'next_week'">There are no tasks for next week.</span>
                        </ng-container>
                      </ng-container>
                      <ng-template #anotherEmptyText>
                        There are no {{tab.label | lowercase}} with this contact yet.
                      </ng-template>
                    </h4>
                  </div>
                </ng-template>
              </ng-template>
            </div>
          </div>
        </div>
    </div>
</div>


<div class="reload c-pointer" (click)="reloadLatest()">
  <i class="i-icon i-refresh d-block bgc-white" [class.progressing]="loading"></i>
</div>